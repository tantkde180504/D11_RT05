/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/10.1.33
 * Generated at: 2025-07-16 12:26:04 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import jakarta.servlet.*;
import jakarta.servlet.http.*;
import jakarta.servlet.jsp.*;

public final class payment_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports,
                 org.apache.jasper.runtime.JspSourceDirectives {

  private static final jakarta.servlet.jsp.JspFactory _jspxFactory =
          jakarta.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.LinkedHashSet<>(4);
    _jspx_imports_packages.add("jakarta.servlet");
    _jspx_imports_packages.add("jakarta.servlet.http");
    _jspx_imports_packages.add("jakarta.servlet.jsp");
    _jspx_imports_classes = null;
  }

  private volatile jakarta.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public boolean getErrorOnELNotFound() {
    return false;
  }

  public jakarta.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final jakarta.servlet.http.HttpServletRequest request, final jakarta.servlet.http.HttpServletResponse response)
      throws java.io.IOException, jakarta.servlet.ServletException {

    if (!jakarta.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      final java.lang.String _jspx_method = request.getMethod();
      if ("OPTIONS".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        return;
      }
      if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
        return;
      }
    }

    final jakarta.servlet.jsp.PageContext pageContext;
    jakarta.servlet.http.HttpSession session = null;
    final jakarta.servlet.ServletContext application;
    final jakarta.servlet.ServletConfig config;
    jakarta.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    jakarta.servlet.jsp.JspWriter _jspx_out = null;
    jakarta.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;


    String contextPath = request.getContextPath();

      out.write("<!DOCTYPE html>\r\n");
      out.write("<html lang=\"vi\">\r\n");
      out.write("\r\n");
      out.write("<head>\r\n");
      out.write("    <meta charset=\"UTF-8\">\r\n");
      out.write("    <title>Thanh toán đơn hàng</title>\r\n");
      out.write("    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\r\n");
      out.write("    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\r\n");
      out.write("    <link href=\"css/payment.css\" rel=\"stylesheet\">\r\n");
      out.write("</head>\r\n");
      out.write("\r\n");
      out.write("<body style=\"background:#f5f5f5;\">\r\n");
      out.write("    <script>\r\n");
      out.write("        // Khai báo contextPath để sử dụng trong JavaScript\r\n");
      out.write("        const contextPath = '");
      out.print( contextPath );
      out.write("';\r\n");
      out.write("        \r\n");
      out.write("        // Debug localStorage ngay khi trang load\r\n");
      out.write("        console.log('=== PAYMENT PAGE LOADED ===');\r\n");
      out.write("        console.log('URL:', window.location.href);\r\n");
      out.write("        console.log('localStorage buyNowMode:', localStorage.getItem('buyNowMode'));\r\n");
      out.write("        console.log('localStorage buyNowItem:', localStorage.getItem('buyNowItem'));\r\n");
      out.write("        console.log('URL params:', window.location.search);\r\n");
      out.write("    </script>\r\n");
      out.write("        <div class=\"row justify-content-center\">\r\n");
      out.write("            <div class=\"col-lg-7\">\r\n");
      out.write("                <div class=\"checkout-section mb-4\">\r\n");
      out.write("                    <div class=\"checkout-title\"><i class=\"fas fa-receipt me-2\"></i>Thông tin thanh toán</div>\r\n");
      out.write("                    <form id=\"checkout-form\">\r\n");
      out.write("                        <div class=\"row mb-3\">\r\n");
      out.write("                            <div class=\"col-md-6 mb-3 mb-md-0\">\r\n");
      out.write("                                <label class=\"form-label\">Họ và tên <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                <input type=\"text\" class=\"form-control\" placeholder=\"Nhập họ và tên\" required>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-6\">\r\n");
      out.write("                                <label class=\"form-label\">Số điện thoại <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                <input type=\"tel\" class=\"form-control\" placeholder=\"Nhập số điện thoại\" required>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        <div class=\"mb-3\">\r\n");
      out.write("                            <label class=\"form-label\">Địa chỉ nhận hàng <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                            <input type=\"text\" class=\"form-control\" placeholder=\"Nhập địa chỉ nhận hàng\" required>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        <div class=\"mb-3\">\r\n");
      out.write("                            <label class=\"form-label\">Ghi chú đơn hàng</label>\r\n");
      out.write("                            <textarea class=\"form-control\" rows=\"3\" placeholder=\"Ghi chú thêm (nếu có)\"></textarea>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        <div class=\"mb-4 payment-method\">\r\n");
      out.write("                            <label class=\"form-label mb-2\">Phương thức thanh toán</label>\r\n");
      out.write("                            <div class=\"form-check\">\r\n");
      out.write("                                <input class=\"form-check-input\" type=\"radio\" name=\"payment\" id=\"cod\" checked>\r\n");
      out.write("                                <label class=\"form-check-label\" for=\"cod\">\r\n");
      out.write("                                    Thanh toán khi nhận hàng (COD)\r\n");
      out.write("                                </label>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"form-check\">\r\n");
      out.write("                                <input class=\"form-check-input\" type=\"radio\" name=\"payment\" id=\"bank\">\r\n");
      out.write("                                <label class=\"form-check-label\" for=\"bank\">\r\n");
      out.write("                                    Thanh toán qua PayOS\r\n");
      out.write("                                </label>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div id=\"payos-section\" class=\"mt-3\" style=\"display:none;\">\r\n");
      out.write("                                <div class=\"alert alert-info py-2 mb-2\">\r\n");
      out.write("                                    <i class=\"fas fa-credit-card me-2\"></i>\r\n");
      out.write("                                    Bạn sẽ được chuyển đến cổng thanh toán PayOS để hoàn tất giao dịch.\r\n");
      out.write("                                </div>\r\n");
      out.write("                                <div class=\"text-center\">\r\n");
      out.write("                                    <img src=\"https://docs.payos.vn/img/logo.svg\" \r\n");
      out.write("                                         alt=\"PayOS Logo\" style=\"max-width:150px;\">\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        <button type=\"submit\" class=\"btn btn-danger w-100 py-2 fs-5\">Đặt hàng</button>\r\n");
      out.write("                    </form>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("            <div class=\"col-lg-5\">\r\n");
      out.write("                <div class=\"order-summary shadow-sm mb-4\">\r\n");
      out.write("                    <h5 class=\"mb-3\"><i class=\"fas fa-list-ul me-2\"></i>Đơn hàng của bạn</h5>\r\n");
      out.write("                    <div id=\"order-summary-list\">\r\n");
      out.write("                        <div class=\"text-muted\">Đang tải giỏ hàng...</div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <a href=\"#\" class=\"btn btn-outline-secondary w-100\" onclick=\"goBackToPrevious()\">\r\n");
      out.write("                    <i class=\"fas fa-arrow-left me-1\"></i>\r\n");
      out.write("                    <span id=\"backButtonText\">Quay lại giỏ hàng</span>\r\n");
      out.write("                </a>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal Thanh toán thành công -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"successModal\" tabindex=\"-1\" aria-labelledby=\"successModalLabel\" aria-hidden=\"true\">\r\n");
      out.write("        <div class=\"modal-dialog modal-dialog-centered\">\r\n");
      out.write("            <div class=\"modal-content text-center\">\r\n");
      out.write("                <div class=\"modal-header border-0\">\r\n");
      out.write("                    <h5 class=\"modal-title w-100\" id=\"successModalLabel\">Thanh toán thành công!</h5>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\">\r\n");
      out.write("                    <i class=\"fas fa-check-circle fa-4x text-success mb-3\"></i>\r\n");
      out.write("                    <p class=\"mb-4\">Cảm ơn bạn đã đặt hàng. Đơn hàng của bạn đã được ghi nhận.</p>\r\n");
      out.write("                    <div class=\"d-grid gap-2\">\r\n");
      out.write("                        <a href=\"");
      out.print(request.getContextPath());
      out.write("/index.jsp\" class=\"btn btn-primary\">Quay về trang chủ</a>\r\n");
      out.write("                        <a href=\"");
      out.print(request.getContextPath());
      out.write("/order-history.jsp\" class=\"btn btn-outline-secondary\">Lịch sử đơn hàng</a>\r\n");
      out.write("                        <a href=\"");
      out.print(request.getContextPath());
      out.write("/all-products.jsp\" class=\"btn btn-outline-success\">Tiếp tục mua sắm</a>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <script>\r\n");
      out.write("document.addEventListener('DOMContentLoaded', function() {\r\n");
      out.write("    const codRadio = document.getElementById('cod');\r\n");
      out.write("    const bankRadio = document.getElementById('bank');\r\n");
      out.write("    const payosSection = document.getElementById('payos-section');\r\n");
      out.write("    const checkoutForm = document.getElementById('checkout-form');\r\n");
      out.write("\r\n");
      out.write("    function togglePayOS() {\r\n");
      out.write("        payosSection.style.display = bankRadio.checked ? 'block' : 'none';\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    codRadio.addEventListener('change', togglePayOS);\r\n");
      out.write("    bankRadio.addEventListener('change', togglePayOS);\r\n");
      out.write("    togglePayOS();\r\n");
      out.write("\r\n");
      out.write("    checkoutForm.addEventListener('submit', async function(e) {\r\n");
      out.write("        e.preventDefault();\r\n");
      out.write("        \r\n");
      out.write("        // Lấy dữ liệu form\r\n");
      out.write("        const fullName = checkoutForm.querySelector('input[placeholder=\"Nhập họ và tên\"]').value.trim();\r\n");
      out.write("        const phone = checkoutForm.querySelector('input[placeholder=\"Nhập số điện thoại\"]').value.trim();\r\n");
      out.write("        const address = checkoutForm.querySelector('input[placeholder=\"Nhập địa chỉ nhận hàng\"]').value.trim();\r\n");
      out.write("        const note = checkoutForm.querySelector('textarea').value.trim();\r\n");
      out.write("        const paymentMethod = bankRadio.checked ? 'BANK_TRANSFER' : 'COD';\r\n");
      out.write("\r\n");
      out.write("        // Validate form\r\n");
      out.write("        if (!fullName || !phone || !address) {\r\n");
      out.write("            alert('Vui lòng điền đầy đủ thông tin bắt buộc!');\r\n");
      out.write("            return;\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        try {\r\n");
      out.write("            const paymentMethod = bankRadio.checked ? 'BANK_TRANSFER' : 'COD';\r\n");
      out.write("            \r\n");
      out.write("            // Kiểm tra chế độ mua hàng\r\n");
      out.write("            const urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("            const isBuyNowMode = urlParams.get('mode') === 'buynow' || localStorage.getItem('buyNowMode') === 'true';\r\n");
      out.write("            \r\n");
      out.write("            // Chuẩn bị payload tùy theo chế độ\r\n");
      out.write("            let payload = {\r\n");
      out.write("                fullName, phone, address, note, paymentMethod\r\n");
      out.write("            };\r\n");
      out.write("            \r\n");
      out.write("            if (isBuyNowMode) {\r\n");
      out.write("                // Mua ngay - gửi thông tin sản phẩm trực tiếp\r\n");
      out.write("                const buyNowItem = localStorage.getItem('buyNowItem');\r\n");
      out.write("                if (!buyNowItem) {\r\n");
      out.write("                    alert('Không tìm thấy thông tin sản phẩm!');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                const item = JSON.parse(buyNowItem);\r\n");
      out.write("                payload.buyNowMode = true;\r\n");
      out.write("                payload.productId = item.productId || item.id;\r\n");
      out.write("                payload.quantity = item.quantity;\r\n");
      out.write("                payload.items = [item]; // Để PayOS tính tổng tiền\r\n");
      out.write("            } else {\r\n");
      out.write("                // Từ giỏ hàng - gửi thông tin các sản phẩm được chọn\r\n");
      out.write("                payload.buyNowMode = false;\r\n");
      out.write("                \r\n");
      out.write("                // Lấy danh sách sản phẩm được chọn từ localStorage\r\n");
      out.write("                let selectedCartIds = [];\r\n");
      out.write("                try {\r\n");
      out.write("                    selectedCartIds = JSON.parse(localStorage.getItem('selectedCartIds')) || [];\r\n");
      out.write("                } catch (e) { \r\n");
      out.write("                    selectedCartIds = []; \r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                // Gửi danh sách ID sản phẩm được chọn để backend xử lý\r\n");
      out.write("                payload.selectedCartIds = selectedCartIds;\r\n");
      out.write("                \r\n");
      out.write("                // Lấy thông tin cart từ API để gửi kèm\r\n");
      out.write("                try {\r\n");
      out.write("                    const cartResponse = await fetch('/api/cart');\r\n");
      out.write("                    if (cartResponse.ok) {\r\n");
      out.write("                        const cartData = await cartResponse.json();\r\n");
      out.write("                        if (cartData.success) {\r\n");
      out.write("                            // Lọc chỉ những sản phẩm được chọn\r\n");
      out.write("                            let selectedItems = cartData.cartItems;\r\n");
      out.write("                            if (selectedCartIds.length > 0) {\r\n");
      out.write("                                selectedItems = cartData.cartItems.filter(item => \r\n");
      out.write("                                    selectedCartIds.includes(item.productId)\r\n");
      out.write("                                );\r\n");
      out.write("                            }\r\n");
      out.write("                            payload.items = selectedItems;\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                } catch (e) {\r\n");
      out.write("                    console.error('Failed to fetch cart for payment:', e);\r\n");
      out.write("                    payload.items = [];\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                console.log('Cart mode - Selected cart IDs:', selectedCartIds);\r\n");
      out.write("                console.log('Cart mode - Items being sent:', payload.items);\r\n");
      out.write("                console.log('Cart mode - Payload being sent:', payload);\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Gửi request đến API\r\n");
      out.write("            console.log('Sending payment request with payload:', payload);\r\n");
      out.write("            \r\n");
      out.write("            const response = await fetch('/api/payment', {\r\n");
      out.write("                method: 'POST',\r\n");
      out.write("                headers: { \r\n");
      out.write("                    'Content-Type': 'application/json',\r\n");
      out.write("                    'Accept': 'application/json'\r\n");
      out.write("                },\r\n");
      out.write("                body: JSON.stringify(payload)\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            console.log('Response status:', response.status);\r\n");
      out.write("            console.log('Response headers:', response.headers);\r\n");
      out.write("            \r\n");
      out.write("            if (!response.ok) {\r\n");
      out.write("                throw new Error(`HTTP error! status: ");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${response.status}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("`);\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            const data = await response.json();\r\n");
      out.write("            console.log('Payment response:', data);\r\n");
      out.write("\r\n");
      out.write("            if (data.success) {\r\n");
      out.write("                if (paymentMethod === 'BANK_TRANSFER' && data.checkoutUrl) {\r\n");
      out.write("                    // PayOS - chuyển hướng đến checkout\r\n");
      out.write("                    console.log('Redirecting to PayOS:', data.checkoutUrl);\r\n");
      out.write("                    \r\n");
      out.write("                    // KHÔNG xóa selectedCartIds ở đây - cần giữ lại để xử lý khi thanh toán thành công\r\n");
      out.write("                    // selectedCartIds sẽ được xóa trong confirmPayOSPayment sau khi thanh toán thành công\r\n");
      out.write("                    \r\n");
      out.write("                    window.location.href = data.checkoutUrl;\r\n");
      out.write("                } else {\r\n");
      out.write("                    // COD - hiển thị modal thành công\r\n");
      out.write("                    // Xóa dữ liệu sau khi đặt hàng thành công\r\n");
      out.write("                    if (isBuyNowMode) {\r\n");
      out.write("                        localStorage.removeItem('buyNowItem');\r\n");
      out.write("                        localStorage.removeItem('buyNowMode');\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Xóa thông tin các sản phẩm đã thanh toán khỏi localStorage\r\n");
      out.write("                        localStorage.removeItem('selectedCartIds');\r\n");
      out.write("                    }\r\n");
      out.write("                    \r\n");
      out.write("                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));\r\n");
      out.write("                    successModal.show();\r\n");
      out.write("                }\r\n");
      out.write("            } else {\r\n");
      out.write("                console.error('Payment error:', data);\r\n");
      out.write("                alert(data.message || 'Đặt hàng thất bại! Vui lòng thử lại.');\r\n");
      out.write("            }\r\n");
      out.write("        } catch (error) {\r\n");
      out.write("            console.error('Error:', error);\r\n");
      out.write("            alert('Lỗi kết nối máy chủ!');\r\n");
      out.write("        }\r\n");
      out.write("    });\r\n");
      out.write("\r\n");
      out.write("    // Render order summary\r\n");
      out.write("    async function renderOrderSummary() {\r\n");
      out.write("        const orderSummaryList = document.getElementById('order-summary-list');\r\n");
      out.write("        let cartItems = [];\r\n");
      out.write("        let grandTotal = 0;\r\n");
      out.write("        \r\n");
      out.write("        // Kiểm tra nếu đang ở chế độ \"Mua ngay\"\r\n");
      out.write("        const urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("        const isBuyNowMode = urlParams.get('mode') === 'buynow' || localStorage.getItem('buyNowMode') === 'true';\r\n");
      out.write("        \r\n");
      out.write("        console.log('=== PAYMENT DEBUG ===');\r\n");
      out.write("        console.log('URL params mode:', urlParams.get('mode'));\r\n");
      out.write("        console.log('localStorage buyNowMode:', localStorage.getItem('buyNowMode'));\r\n");
      out.write("        console.log('isBuyNowMode:', isBuyNowMode);\r\n");
      out.write("        console.log('localStorage buyNowItem:', localStorage.getItem('buyNowItem'));\r\n");
      out.write("        \r\n");
      out.write("        if (isBuyNowMode) {\r\n");
      out.write("            // Lấy sản phẩm từ \"Mua ngay\"\r\n");
      out.write("            const buyNowItem = localStorage.getItem('buyNowItem');\r\n");
      out.write("            console.log('Buy now item from localStorage:', buyNowItem);\r\n");
      out.write("            \r\n");
      out.write("            if (buyNowItem) {\r\n");
      out.write("                try {\r\n");
      out.write("                    const item = JSON.parse(buyNowItem);\r\n");
      out.write("                    console.log('Parsed buy now item:', item);\r\n");
      out.write("                    cartItems = [item];\r\n");
      out.write("                    grandTotal = item.price * item.quantity;\r\n");
      out.write("                    \r\n");
      out.write("                    // Cập nhật text nút quay lại\r\n");
      out.write("                    const backButtonText = document.getElementById('backButtonText');\r\n");
      out.write("                    if (backButtonText) {\r\n");
      out.write("                        backButtonText.textContent = 'Quay lại sản phẩm';\r\n");
      out.write("                    }\r\n");
      out.write("                    console.log('Buy now cart setup successful:', cartItems, 'total:', grandTotal);\r\n");
      out.write("                } catch (e) {\r\n");
      out.write("                    console.error('Error parsing buyNowItem:', e);\r\n");
      out.write("                    cartItems = [];\r\n");
      out.write("                    grandTotal = 0;\r\n");
      out.write("                }\r\n");
      out.write("            } else {\r\n");
      out.write("                console.error('No buyNowItem found in localStorage!');\r\n");
      out.write("                \r\n");
      out.write("                // Thử phục hồi từ URL params\r\n");
      out.write("                const productId = urlParams.get('productId');\r\n");
      out.write("                const quantity = urlParams.get('quantity');\r\n");
      out.write("                const price = urlParams.get('price');\r\n");
      out.write("                \r\n");
      out.write("                if (productId && quantity && price) {\r\n");
      out.write("                    console.log('Trying to recover from URL params...');\r\n");
      out.write("                    try {\r\n");
      out.write("                        // Tạo lại item từ URL params\r\n");
      out.write("                        const recoveredItem = {\r\n");
      out.write("                            id: parseInt(productId),\r\n");
      out.write("                            productId: parseInt(productId),\r\n");
      out.write("                            name: 'Sản phẩm #' + productId, // Tên tạm thời\r\n");
      out.write("                            productName: 'Sản phẩm #' + productId,\r\n");
      out.write("                            price: parseFloat(price),\r\n");
      out.write("                            quantity: parseInt(quantity),\r\n");
      out.write("                            imageUrl: contextPath + '/img/RGStrikeGundam.jpg'\r\n");
      out.write("                        };\r\n");
      out.write("                        \r\n");
      out.write("                        // Lưu lại vào localStorage\r\n");
      out.write("                        localStorage.setItem('buyNowItem', JSON.stringify(recoveredItem));\r\n");
      out.write("                        localStorage.setItem('buyNowMode', 'true');\r\n");
      out.write("                        \r\n");
      out.write("                        cartItems = [recoveredItem];\r\n");
      out.write("                        grandTotal = recoveredItem.price * recoveredItem.quantity;\r\n");
      out.write("                        \r\n");
      out.write("                        console.log('Successfully recovered item from URL params:', recoveredItem);\r\n");
      out.write("                        \r\n");
      out.write("                        // Cập nhật text nút quay lại\r\n");
      out.write("                        const backButtonText = document.getElementById('backButtonText');\r\n");
      out.write("                        if (backButtonText) {\r\n");
      out.write("                            backButtonText.textContent = 'Quay lại sản phẩm';\r\n");
      out.write("                        }\r\n");
      out.write("                    } catch (e) {\r\n");
      out.write("                        console.error('Failed to recover from URL params:', e);\r\n");
      out.write("                        // Hiển thị thông báo lỗi\r\n");
      out.write("                        orderSummaryList.innerHTML = `\r\n");
      out.write("                            <div class=\"alert alert-warning text-center\">\r\n");
      out.write("                                <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n");
      out.write("                                <div>Không thể khôi phục thông tin sản phẩm!</div>\r\n");
      out.write("                                <div class=\"mt-2\">\r\n");
      out.write("                                    <a href=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${contextPath}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("/all-products.jsp\" class=\"btn btn-sm btn-primary\">\r\n");
      out.write("                                        Quay lại mua sắm\r\n");
      out.write("                                    </a>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        `;\r\n");
      out.write("                        return;\r\n");
      out.write("                    }\r\n");
      out.write("                } else {\r\n");
      out.write("                    // Hiển thị thông báo lỗi cụ thể cho chế độ mua ngay\r\n");
      out.write("                    orderSummaryList.innerHTML = `\r\n");
      out.write("                        <div class=\"alert alert-warning text-center\">\r\n");
      out.write("                            <i class=\"fas fa-exclamation-triangle me-2\"></i>\r\n");
      out.write("                            <div>Không tìm thấy thông tin sản phẩm!</div>\r\n");
      out.write("                            <div class=\"mt-2\">\r\n");
      out.write("                                <a href=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${contextPath}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("/all-products.jsp\" class=\"btn btn-sm btn-primary\">\r\n");
      out.write("                                    Quay lại mua sắm\r\n");
      out.write("                                </a>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    `;\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("        } else {\r\n");
      out.write("            // Lấy cart từ API\r\n");
      out.write("            try {\r\n");
      out.write("                const resp = await fetch('/api/cart', { headers: { 'Accept': 'application/json' } });\r\n");
      out.write("                const data = await resp.json();\r\n");
      out.write("                if (data.success) {\r\n");
      out.write("                    const allCartItems = data.cartItems;\r\n");
      out.write("                    \r\n");
      out.write("                    // Lấy danh sách sản phẩm được chọn từ localStorage\r\n");
      out.write("                    let selectedCartIds = [];\r\n");
      out.write("                    try {\r\n");
      out.write("                        selectedCartIds = JSON.parse(localStorage.getItem('selectedCartIds')) || [];\r\n");
      out.write("                    } catch (e) { \r\n");
      out.write("                        selectedCartIds = []; \r\n");
      out.write("                    }\r\n");
      out.write("                    \r\n");
      out.write("                    // Nếu không có sản phẩm nào được chọn, mặc định chọn tất cả\r\n");
      out.write("                    if (selectedCartIds.length === 0) {\r\n");
      out.write("                        cartItems = allCartItems;\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Chỉ lấy những sản phẩm được chọn\r\n");
      out.write("                        cartItems = allCartItems.filter(item => \r\n");
      out.write("                            selectedCartIds.includes(item.productId)\r\n");
      out.write("                        );\r\n");
      out.write("                    }\r\n");
      out.write("                    \r\n");
      out.write("                    grandTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n");
      out.write("                    \r\n");
      out.write("                    console.log('Selected cart IDs:', selectedCartIds);\r\n");
      out.write("                    console.log('All cart items:', allCartItems);\r\n");
      out.write("                    console.log('Filtered cart items for payment:', cartItems);\r\n");
      out.write("                }\r\n");
      out.write("            } catch (err) {\r\n");
      out.write("                console.error('Error fetching cart:', err);\r\n");
      out.write("                cartItems = [];\r\n");
      out.write("                grandTotal = 0;\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        if (!cartItems.length) {\r\n");
      out.write("            orderSummaryList.innerHTML = '<div class=\"text-danger\">Không có sản phẩm nào!</div>';\r\n");
      out.write("            return;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        let html = '';\r\n");
      out.write("        \r\n");
      out.write("        // Thêm thông báo nếu đang ở chế độ cart và có sản phẩm được chọn\r\n");
      out.write("        if (!isBuyNowMode) {\r\n");
      out.write("            let selectedCartIds = [];\r\n");
      out.write("            try {\r\n");
      out.write("                selectedCartIds = JSON.parse(localStorage.getItem('selectedCartIds')) || [];\r\n");
      out.write("            } catch (e) { selectedCartIds = []; }\r\n");
      out.write("            \r\n");
      out.write("            if (selectedCartIds.length > 0) {\r\n");
      out.write("                html += '<div class=\"alert alert-info text-center py-2 mb-3\">';\r\n");
      out.write("                html += '<i class=\"fas fa-info-circle me-2\"></i>';\r\n");
      out.write("                html += '<small>Bạn đang thanh toán ' + cartItems.length + ' sản phẩm đã chọn</small>';\r\n");
      out.write("                html += '</div>';\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        cartItems.forEach(item => {\r\n");
      out.write("            html += '<div class=\"d-flex justify-content-between mb-2\">'\r\n");
      out.write("                + '<span>' + (item.productName || item.name) + ' x ' + item.quantity + '</span>'\r\n");
      out.write("                + '<span>' + formatCurrency(item.price * item.quantity) + '₫</span>'\r\n");
      out.write("                + '</div>';\r\n");
      out.write("        });\r\n");
      out.write("        html += '<hr>';\r\n");
      out.write("        html += '<div class=\"d-flex justify-content-between mb-2\">'\r\n");
      out.write("            + '<span class=\"fw-bold\">Tạm tính</span>'\r\n");
      out.write("            + '<span class=\"fw-bold\">' + formatCurrency(grandTotal) + '₫</span>'\r\n");
      out.write("            + '</div>';\r\n");
      out.write("        html += '<div class=\"d-flex justify-content-between mb-2\">'\r\n");
      out.write("            + '<span>Phí vận chuyển</span>'\r\n");
      out.write("            + '<span>Miễn phí</span>'\r\n");
      out.write("            + '</div>';\r\n");
      out.write("        html += '<hr>';\r\n");
      out.write("        html += '<div class=\"d-flex justify-content-between mb-2\">'\r\n");
      out.write("            + '<span class=\"fw-bold text-danger\">Tổng cộng</span>'\r\n");
      out.write("            + '<span class=\"fw-bold fs-5 text-danger\">' + formatCurrency(grandTotal) + '₫</span>'\r\n");
      out.write("            + '</div>';\r\n");
      out.write("        orderSummaryList.innerHTML = html;\r\n");
      out.write("    }\r\n");
      out.write("    function formatCurrency(num) {\r\n");
      out.write("        return num.toLocaleString('vi-VN');\r\n");
      out.write("    }\r\n");
      out.write("    \r\n");
      out.write("    // Function để xử lý nút quay lại\r\n");
      out.write("    function goBackToPrevious() {\r\n");
      out.write("        const urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("        const isBuyNowMode = urlParams.get('mode') === 'buynow' || localStorage.getItem('buyNowMode') === 'true';\r\n");
      out.write("        \r\n");
      out.write("        if (isBuyNowMode) {\r\n");
      out.write("            // Xóa dữ liệu \"Mua ngay\" khỏi localStorage\r\n");
      out.write("            localStorage.removeItem('buyNowItem');\r\n");
      out.write("            localStorage.removeItem('buyNowMode');\r\n");
      out.write("            \r\n");
      out.write("            // Quay lại trang trước đó hoặc trang chủ\r\n");
      out.write("            if (document.referrer && document.referrer.includes('/product-detail.jsp')) {\r\n");
      out.write("                window.location.href = document.referrer;\r\n");
      out.write("            } else {\r\n");
      out.write("                window.location.href = contextPath + '/all-products.jsp';\r\n");
      out.write("            }\r\n");
      out.write("        } else {\r\n");
      out.write("            // Quay lại giỏ hàng\r\n");
      out.write("            window.location.href = contextPath + '/cart.jsp';\r\n");
      out.write("        }\r\n");
      out.write("    }\r\n");
      out.write("    \r\n");
      out.write("    // Load order summary when page loads\r\n");
      out.write("    renderOrderSummary();\r\n");
      out.write("    \r\n");
      out.write("    // Also set timeout để đảm bảo load sau khi DOM sẵn sàng\r\n");
      out.write("    setTimeout(() => {\r\n");
      out.write("        console.log('Timeout - rendering order summary again...');\r\n");
      out.write("        renderOrderSummary();\r\n");
      out.write("    }, 100);\r\n");
      out.write("});\r\n");
      out.write("</script>\r\n");
      out.write("<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\r\n");
      out.write("</body>\r\n");
      out.write("</html>");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof jakarta.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
