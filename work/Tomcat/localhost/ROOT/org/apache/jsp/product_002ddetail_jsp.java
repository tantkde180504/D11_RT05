/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/10.1.33
 * Generated at: 2025-07-11 16:16:52 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import jakarta.servlet.*;
import jakarta.servlet.http.*;
import jakarta.servlet.jsp.*;
import java.util.*;
import java.text.NumberFormat;
import java.util.Locale;
import com.mycompany.model.Product;

public final class product_002ddetail_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports,
                 org.apache.jasper.runtime.JspSourceDirectives {

  private static final jakarta.servlet.jsp.JspFactory _jspxFactory =
          jakarta.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  static {
    _jspx_dependants = new java.util.HashMap<java.lang.String,java.lang.Long>(1);
    _jspx_dependants.put("/includes/mobile-sidebar.jsp", Long.valueOf(1752246080343L));
  }

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.LinkedHashSet<>(6);
    _jspx_imports_packages.add("java.util");
    _jspx_imports_packages.add("jakarta.servlet");
    _jspx_imports_packages.add("jakarta.servlet.http");
    _jspx_imports_packages.add("jakarta.servlet.jsp");
    _jspx_imports_classes = new java.util.LinkedHashSet<>(4);
    _jspx_imports_classes.add("java.util.Locale");
    _jspx_imports_classes.add("com.mycompany.model.Product");
    _jspx_imports_classes.add("java.text.NumberFormat");
  }

  private volatile jakarta.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public boolean getErrorOnELNotFound() {
    return false;
  }

  public jakarta.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final jakarta.servlet.http.HttpServletRequest request, final jakarta.servlet.http.HttpServletResponse response)
      throws java.io.IOException, jakarta.servlet.ServletException {

    if (!jakarta.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      final java.lang.String _jspx_method = request.getMethod();
      if ("OPTIONS".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        return;
      }
      if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method)) {
        response.setHeader("Allow","GET, HEAD, POST, OPTIONS");
        response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
        return;
      }
    }

    final jakarta.servlet.jsp.PageContext pageContext;
    jakarta.servlet.http.HttpSession session = null;
    final jakarta.servlet.ServletContext application;
    final jakarta.servlet.ServletConfig config;
    jakarta.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    jakarta.servlet.jsp.JspWriter _jspx_out = null;
    jakarta.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			"error.jsp", true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;


    // Lấy thông tin sản phẩm từ request parameter hoặc attribute
    String productIdParam = request.getParameter("id");
    Long productId = null;
    
    if (productIdParam != null && !productIdParam.trim().isEmpty()) {
        try {
            productId = Long.parseLong(productIdParam);
        } catch (NumberFormatException e) {
            response.sendRedirect(request.getContextPath() + "/all-products.jsp");
            return;
        }
    }
    
    // Nếu không có ID, redirect về trang all-products
    if (productId == null) {
        response.sendRedirect(request.getContextPath() + "/all-products.jsp");
        return;
    }
    
    // Format number cho giá tiền (VND)
    NumberFormat vndFormat = NumberFormat.getInstance(new Locale("vi", "VN"));

      out.write("<!DOCTYPE html>\n");
      out.write("<html lang=\"vi\">\n");
      out.write("<head>\n");
      out.write("    <meta charset=\"UTF-8\">\n");
      out.write("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n");
      out.write("    <title>Chi tiết sản phẩm - 43 Gundam Hobby</title>\n");
      out.write("    <meta name=\"description\" content=\"Xem chi tiết sản phẩm mô hình Gundam chính hãng tại 43 Gundam Hobby\">\n");
      out.write("    <meta name=\"keywords\" content=\"gundam, mô hình, bandai, chi tiết sản phẩm\">\n");
      out.write("    \n");
      out.write("    <!-- Bootstrap & FontAwesome -->\n");
      out.write("    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\n");
      out.write("    \n");
      out.write("    <!-- Custom CSS -->\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/styles.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/navbar-darkmode.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/navbar-bg-orange.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/navbar-menu-white.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/hamburger-menu.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/product-detail.css\" rel=\"stylesheet\">\n");
      out.write("    \n");
      out.write("    <!-- Google OAuth Handler -->\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/navbar-manager.js\"></script>\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/google-oauth-clean.js\"></script>\n");
      out.write("    \n");
      out.write("    <!-- Google Fonts -->\n");
      out.write("    <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n");
      out.write("    <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n");
      out.write("    <link href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap\" rel=\"stylesheet\">\n");
      out.write("</head>\n");
      out.write("<body>\n");
      out.write("    <!-- Header -->\n");
      out.write("    <header class=\"bg-white shadow-sm sticky-top\">\n");
      out.write("        <div class=\"container\">\n");
      out.write("            <div class=\"row align-items-center py-3\">\n");
      out.write("                <!-- Logo Section with Hamburger Menu -->\n");
      out.write("                <div class=\"col-lg-3 col-md-4 col-6\">\n");
      out.write("                    <div class=\"header-logo-section\">\n");
      out.write("                        <!-- Hamburger Menu (Mobile) -->\n");
      out.write("                        <button class=\"hamburger-menu\" id=\"hamburgerBtn\" aria-label=\"Menu\">\n");
      out.write("                            <span class=\"line\"></span>\n");
      out.write("                            <span class=\"line\"></span>\n");
      out.write("                            <span class=\"line\"></span>\n");
      out.write("                        </button>\n");
      out.write("                        \n");
      out.write("                        <div class=\"logo\">\n");
      out.write("                            <a href=\"");
      out.print(request.getContextPath());
      out.write("/\">\n");
      out.write("                                <img src=\"");
      out.print(request.getContextPath());
      out.write("/img/logo.png\" alt=\"43 Gundam Logo\" class=\"logo-img\">\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <!-- Search Section -->\n");
      out.write("                <div class=\"col-lg-6 col-md-4 col-12 order-md-2 order-3\">\n");
      out.write("                    <div class=\"header-center-section\">\n");
      out.write("                        <div class=\"search-container\">\n");
      out.write("                            <form class=\"search-form\" action=\"");
      out.print(request.getContextPath());
      out.write("/search\" method=\"get\" id=\"headerSearchForm\">\n");
      out.write("                                <div class=\"input-group\">\n");
      out.write("                                    <input type=\"text\" class=\"form-control search-input\" name=\"q\" \n");
      out.write("                                           placeholder=\"Tìm kiếm sản phẩm...\" aria-label=\"Search\" \n");
      out.write("                                           id=\"headerSearchInput\" autocomplete=\"off\">\n");
      out.write("                                    <button class=\"btn btn-search\" type=\"submit\">\n");
      out.write("                                        <i class=\"fas fa-search\"></i>\n");
      out.write("                                    </button>\n");
      out.write("                                </div>\n");
      out.write("                                <!-- Autocomplete suggestions -->\n");
      out.write("                                <div id=\"headerSearchSuggestions\" class=\"search-suggestions\"></div>\n");
      out.write("                            </form>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("                \n");
      out.write("                <!-- User Actions Section -->\n");
      out.write("                <div class=\"col-lg-3 col-md-4 col-6 order-md-3 order-2\">\n");
      out.write("                    <div class=\"header-actions-section\">\n");
      out.write("                        <!-- Account Menu -->\n");
      out.write("                        <div class=\"account-menu me-3\">\n");
      out.write("                            <!-- User Info (visible when logged in) -->\n");
      out.write("                            <div id=\"nav-user-info\" class=\"d-none\">\n");
      out.write("                                <div class=\"dropdown\">\n");
      out.write("                                    <a href=\"#\" class=\"btn btn-outline-success dropdown-toggle\" \n");
      out.write("                                       id=\"userAccountDropdown\" role=\"button\" data-bs-toggle=\"dropdown\">\n");
      out.write("                                        <i class=\"fas fa-user-circle me-1\"></i>\n");
      out.write("                                        <span id=\"userDisplayName\">User</span>\n");
      out.write("                                    </a>\n");
      out.write("                                    <ul class=\"dropdown-menu dropdown-menu-end\">\n");
      out.write("                                        <li><h6 class=\"dropdown-header\">\n");
      out.write("                                            <i class=\"fas fa-user me-2\"></i>\n");
      out.write("                                            <span id=\"userFullName\">User Name</span>\n");
      out.write("                                        </h6></li>\n");
      out.write("                                        <li><hr class=\"dropdown-divider\"></li>\n");
      out.write("                                        <li><a class=\"dropdown-item\" href=\"");
      out.print(request.getContextPath());
      out.write("/profile.jsp\">\n");
      out.write("                                            <i class=\"fas fa-user-edit me-2\"></i>Thông tin tài khoản\n");
      out.write("                                        </a></li>\n");
      out.write("                                        <li><a class=\"dropdown-item\" href=\"#\">\n");
      out.write("                                            <i class=\"fas fa-shopping-bag me-2\"></i>Đơn hàng của tôi\n");
      out.write("                                        </a></li>\n");
      out.write("                                        <li><a class=\"dropdown-item\" href=\"#\">\n");
      out.write("                                            <i class=\"fas fa-heart me-2\"></i>Sản phẩm yêu thích\n");
      out.write("                                        </a></li>\n");
      out.write("                                        <li><hr class=\"dropdown-divider\"></li>\n");
      out.write("                                        <li><a class=\"dropdown-item text-danger\" href=\"#\" onclick=\"userLogout()\">\n");
      out.write("                                            <i class=\"fas fa-sign-out-alt me-2\"></i>Đăng xuất\n");
      out.write("                                        </a></li>\n");
      out.write("                                    </ul>\n");
      out.write("                                </div>\n");
      out.write("                            </div>\n");
      out.write("                            \n");
      out.write("                            <!-- Login Button (visible when not logged in) -->\n");
      out.write("                            <div id=\"nav-login-btn\">\n");
      out.write("                                <div class=\"dropdown\">\n");
      out.write("                                    <a href=\"#\" class=\"btn btn-outline-primary dropdown-toggle\" \n");
      out.write("                                       id=\"accountDropdown\" role=\"button\" data-bs-toggle=\"dropdown\">\n");
      out.write("                                        <i class=\"fas fa-user me-1\"></i>\n");
      out.write("                                        <span class=\"d-none d-md-inline\">Tài khoản</span>\n");
      out.write("                                    </a>\n");
      out.write("                                    <ul class=\"dropdown-menu dropdown-menu-end\">\n");
      out.write("                                        <li><a class=\"dropdown-item\" href=\"");
      out.print(request.getContextPath());
      out.write("/login.jsp\">\n");
      out.write("                                            <i class=\"fas fa-sign-in-alt me-2\"></i>Đăng nhập\n");
      out.write("                                        </a></li>\n");
      out.write("                                        <li><a class=\"dropdown-item\" href=\"");
      out.print(request.getContextPath());
      out.write("/register.jsp\">\n");
      out.write("                                            <i class=\"fas fa-user-plus me-2\"></i>Đăng ký\n");
      out.write("                                        </a></li>\n");
      out.write("                                    </ul>\n");
      out.write("                                </div>\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                        \n");
      out.write("                        <!-- Cart Button -->\n");
      out.write("                        <div class=\"cart-btn\">\n");
      out.write("                            <a href=\"cart.jsp\" class=\"btn btn-primary\">\n");
      out.write("                                <i class=\"fas fa-shopping-cart me-1\"></i>\n");
      out.write("                                <span class=\"cart-count\">0</span>\n");
      out.write("                                <span class=\"d-none d-lg-inline ms-1\">Giỏ hàng</span>\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("    </header>\n");
      out.write("\n");
      out.write("    <!-- Include Sidebar Navigation -->\n");
      out.write("    ");
      out.write("<!-- Universal Sidebar Navigation (works on all screen sizes) -->\n");
      out.write("<div class=\"mobile-sidebar\" id=\"mobileSidebar\">\n");
      out.write("    <button class=\"sidebar-close\" id=\"sidebarClose\" aria-label=\"Đóng menu\">&times;</button>\n");
      out.write("    \n");
      out.write("    <div class=\"sidebar-header\">\n");
      out.write("        <h4><i class=\"fas fa-rocket me-2\"></i>GundamHobby Menu</h4>\n");
      out.write("        <p class=\"mb-0 text-muted small\">✨ Khám phá thế giới mô hình tuyệt vời</p>\n");
      out.write("    </div>\n");
      out.write("    \n");
      out.write("    <!-- Category Section in Sidebar -->\n");
      out.write("    <div class=\"category-section\">\n");
      out.write("        <h5><i class=\"fas fa-layer-group me-2\"></i>Danh Mục Sản Phẩm</h5>\n");
      out.write("        <ul class=\"category-list\">\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-robot me-2\"></i>Gundam Bandai</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-industry me-2\"></i>Mô hình Trung</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-gem me-2\"></i>Metal Build - Diecast</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-tools me-2\"></i>Dụng cụ - Tool</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-puzzle-piece me-2\"></i>Phụ kiện - Base</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-dragon me-2\"></i>Mô hình Dragon Ball</a></li>\n");
      out.write("            <li><a href=\"#\"><i class=\"fas fa-palette me-2\"></i>Sơn - Decal</a></li>\n");
      out.write("        </ul>\n");
      out.write("    </div>\n");
      out.write("    \n");
      out.write("    <ul class=\"sidebar-menu\">\n");
      out.write("        <li><a href=\"");
      out.print(request.getContextPath());
      out.write("/\"><i class=\"fas fa-home me-2\"></i>Trang chủ</a></li>\n");
      out.write("        <li><a href=\"");
      out.print(request.getContextPath());
      out.write("/all-products.jsp\"><i class=\"fas fa-th-large me-2\"></i>Tất cả sản phẩm</a></li>\n");
      out.write("        <li><a href=\"#\"><i class=\"fas fa-star me-2\"></i>Hàng mới về</a></li>\n");
      out.write("        <li><a href=\"#\"><i class=\"fas fa-clock me-2\"></i>Hàng Pre-order</a></li>\n");
      out.write("        <li>\n");
      out.write("            <a href=\"#\" data-bs-toggle=\"collapse\" data-bs-target=\"#phukienSubmenu\" aria-expanded=\"false\">\n");
      out.write("                <i class=\"fas fa-cubes me-2\"></i>Phụ kiện & Mô hình <i class=\"fas fa-chevron-down float-end\"></i>\n");
      out.write("            </a>\n");
      out.write("            <ul class=\"collapse submenu\" id=\"phukienSubmenu\">\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-tools me-2\"></i>Dụng cụ - Tool</a></li>\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-puzzle-piece me-2\"></i>Phụ kiện - Base</a></li>\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-dragon me-2\"></i>Mô hình Dragon Ball</a></li>\n");
      out.write("            </ul>\n");
      out.write("        </li>\n");
      out.write("        <li>\n");
      out.write("            <a href=\"#\" data-bs-toggle=\"collapse\" data-bs-target=\"#bandaiSubmenu\" aria-expanded=\"false\">\n");
      out.write("                <i class=\"fas fa-robot me-2\"></i>Bandai Collection <i class=\"fas fa-chevron-down float-end\"></i>\n");
      out.write("            </a>\n");
      out.write("            <ul class=\"collapse submenu\" id=\"bandaiSubmenu\">\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-award me-2\"></i>High Grade (HG)</a></li>\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-trophy me-2\"></i>Master Grade (MG)</a></li>\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-medal me-2\"></i>Real Grade (RG)</a></li>\n");
      out.write("                <li><a href=\"#\"><i class=\"fas fa-crown me-2\"></i>Perfect Grade (PG)</a></li>\n");
      out.write("            </ul>\n");
      out.write("        </li>\n");
      out.write("        <li><a href=\"favorites.jsp\"><i class=\"fas fa-heart me-2\"></i>Yêu thích</a></li>\n");
      out.write("        <li><a href=\"#\"><i class=\"fas fa-user me-2\"></i>Tài khoản</a></li>\n");
      out.write("    </ul>\n");
      out.write("    \n");
      out.write("    <!-- Additional Info Section for Desktop -->\n");
      out.write("    <div class=\"sidebar-footer d-none d-lg-block\">\n");
      out.write("        <div class=\"contact-info mt-4 p-3 rounded\">\n");
      out.write("            <h6 class=\"mb-3\"><i class=\"fas fa-headset me-2\"></i>Liên hệ hỗ trợ</h6>\n");
      out.write("            <p class=\"mb-2 small\"><i class=\"fas fa-map-marker-alt me-2\"></i>59 Lê Đình Diên, Cẩm Lệ, Đà Nẵng</p>\n");
      out.write("            <p class=\"mb-2 small\"><i class=\"fas fa-phone-alt me-2\"></i>0385 546 145</p>\n");
      out.write("            <p class=\"mb-2 small\"><i class=\"fas fa-envelope me-2\"></i>43gundamhobby@gmail.com</p>\n");
      out.write("            <p class=\"mb-0 small\"><i class=\"fas fa-clock me-2\"></i>8:00 - 22:00 hàng ngày</p>\n");
      out.write("        </div>\n");
      out.write("    </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<!-- Sidebar Overlay -->\n");
      out.write("<div class=\"mobile-overlay\" id=\"mobileOverlay\"></div>\n");
      out.write("<!-- Product Detail Container -->\n");
      out.write("    <div class=\"product-detail-container\">\n");
      out.write("        <div class=\"container\">\n");
      out.write("            <!-- Breadcrumb -->\n");
      out.write("            <div class=\"breadcrumb-section\">\n");
      out.write("                <nav aria-label=\"breadcrumb\">\n");
      out.write("                    <ol class=\"breadcrumb\">\n");
      out.write("                        <li class=\"breadcrumb-item\"><a href=\"");
      out.print(request.getContextPath());
      out.write("/\"><i class=\"fas fa-home me-1\"></i>Trang chủ</a></li>\n");
      out.write("                        <li class=\"breadcrumb-item\"><a href=\"");
      out.print(request.getContextPath());
      out.write("/all-products.jsp\">Sản phẩm</a></li>\n");
      out.write("                        <li class=\"breadcrumb-item active\" aria-current=\"page\" id=\"productBreadcrumb\">Chi tiết sản phẩm</li>\n");
      out.write("                    </ol>\n");
      out.write("                </nav>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Loading State -->\n");
      out.write("            <div id=\"loadingState\" class=\"text-center py-5\">\n");
      out.write("                <div class=\"spinner-border text-primary\" style=\"width: 3rem; height: 3rem;\" role=\"status\">\n");
      out.write("                    <span class=\"visually-hidden\">Đang tải...</span>\n");
      out.write("                </div>\n");
      out.write("                <p class=\"mt-3 text-muted\">Đang tải thông tin sản phẩm...</p>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Error State -->\n");
      out.write("            <div id=\"errorState\" class=\"alert alert-danger text-center\" style=\"display: none;\">\n");
      out.write("                <i class=\"fas fa-exclamation-triangle me-2\"></i>\n");
      out.write("                <span id=\"errorMessage\">Có lỗi xảy ra khi tải thông tin sản phẩm.</span>\n");
      out.write("                <div class=\"mt-3\">\n");
      out.write("                    <a href=\"");
      out.print(request.getContextPath());
      out.write("/all-products.jsp\" class=\"btn btn-primary\">\n");
      out.write("                        <i class=\"fas fa-arrow-left me-2\"></i>Quay lại danh sách sản phẩm\n");
      out.write("                    </a>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Product Main Info -->\n");
      out.write("            <div id=\"productMain\" class=\"product-main\" style=\"display: none;\">\n");
      out.write("                <div class=\"row\">\n");
      out.write("                    <!-- Product Images -->\n");
      out.write("                    <div class=\"col-lg-6 col-md-6\">\n");
      out.write("                        <div class=\"product-image-gallery\">\n");
      out.write("                            <div class=\"main-product-image\">\n");
      out.write("                                <div class=\"product-badges\" id=\"productBadges\">\n");
      out.write("                                    <!-- Badges will be inserted here dynamically -->\n");
      out.write("                                </div>\n");
      out.write("                                <img id=\"mainProductImg\" src=\"\" alt=\"Product Image\" class=\"img-fluid\">\n");
      out.write("                            </div>\n");
      out.write("                            <div class=\"product-thumbnails\" id=\"productThumbnails\">\n");
      out.write("                                <!-- Thumbnails will be inserted here if available -->\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    \n");
      out.write("                    <!-- Product Info -->\n");
      out.write("                    <div class=\"col-lg-6 col-md-6\">\n");
      out.write("                        <div class=\"product-info\">\n");
      out.write("                            <h1 class=\"product-title\" id=\"productTitle\">Tên sản phẩm</h1>\n");
      out.write("                            \n");
      out.write("                            <div class=\"product-meta\" id=\"productMeta\">\n");
      out.write("                                <!-- Meta info will be inserted here -->\n");
      out.write("                            </div>\n");
      out.write("                            \n");
      out.write("                            <div class=\"product-price\" id=\"productPrice\">\n");
      out.write("                                <!-- Price will be inserted here -->\n");
      out.write("                            </div>\n");
      out.write("                            \n");
      out.write("                            <div class=\"stock-status\" id=\"stockStatus\">\n");
      out.write("                                <!-- Stock status will be inserted here -->\n");
      out.write("                            </div>\n");
      out.write("                            \n");
      out.write("                            <div class=\"quantity-section\">\n");
      out.write("                                <span class=\"quantity-label\">Số lượng:</span>\n");
      out.write("                                <div class=\"quantity-control\">\n");
      out.write("                                    <button type=\"button\" class=\"quantity-btn\" id=\"decreaseQty\">\n");
      out.write("                                        <i class=\"fas fa-minus\"></i>\n");
      out.write("                                    </button>\n");
      out.write("                                    <input type=\"number\" class=\"quantity-input\" id=\"quantityInput\" value=\"1\" min=\"1\" max=\"10\">\n");
      out.write("                                    <button type=\"button\" class=\"quantity-btn\" id=\"increaseQty\">\n");
      out.write("                                        <i class=\"fas fa-plus\"></i>\n");
      out.write("                                    </button>\n");
      out.write("                                </div>\n");
      out.write("                            </div>\n");
      out.write("                            \n");
      out.write("                            <div class=\"product-actions\">\n");
      out.write("                                <div class=\"action-buttons\">\n");
      out.write("                                    <button type=\"button\" class=\"btn btn-add-cart\" id=\"addToCartBtn\">\n");
      out.write("                                        <i class=\"fas fa-cart-plus me-2\"></i>Thêm vào giỏ hàng\n");
      out.write("                                    </button>\n");
      out.write("                                    <button type=\"button\" class=\"btn btn-buy-now\" id=\"buyNowBtn\">\n");
      out.write("                                        <i class=\"fas fa-bolt me-2\"></i>Mua ngay\n");
      out.write("                                    </button>\n");
      out.write("                                    <button type=\"button\" class=\"btn btn-wishlist\" id=\"wishlistBtn\" title=\"Thêm vào yêu thích\">\n");
      out.write("                                        <i class=\"far fa-heart\"></i>\n");
      out.write("                                    </button>\n");
      out.write("                                </div>\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Product Description -->\n");
      out.write("            <div id=\"productDescription\" class=\"product-description\" style=\"display: none;\">\n");
      out.write("                <h2 class=\"section-title\">\n");
      out.write("                    <i class=\"fas fa-info-circle me-2\"></i>Mô tả sản phẩm\n");
      out.write("                </h2>\n");
      out.write("                <div class=\"description-content\" id=\"descriptionContent\">\n");
      out.write("                    <!-- Description will be inserted here -->\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Product Specifications -->\n");
      out.write("            <div id=\"productSpecifications\" class=\"product-specifications\" style=\"display: none;\">\n");
      out.write("                <h2 class=\"section-title\">\n");
      out.write("                    <i class=\"fas fa-list-ul me-2\"></i>Thông số kỹ thuật\n");
      out.write("                </h2>\n");
      out.write("                <div class=\"table-responsive\">\n");
      out.write("                    <table class=\"spec-table\">\n");
      out.write("                        <tbody id=\"specTableBody\">\n");
      out.write("                            <!-- Specifications will be inserted here -->\n");
      out.write("                        </tbody>\n");
      out.write("                    </table>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Product Reviews Section -->\n");
      out.write("            <div class=\"product-reviews\">\n");
      out.write("                <div class=\"reviews-header\">\n");
      out.write("                    <h2 class=\"section-title\">\n");
      out.write("                        <i class=\"fas fa-star me-2\"></i>Đánh giá sản phẩm\n");
      out.write("                    </h2>\n");
      out.write("                    <div class=\"rating-summary\">\n");
      out.write("                        <div class=\"overall-rating\">\n");
      out.write("                            <div class=\"rating-score\">\n");
      out.write("                                <span class=\"score\" id=\"overallScore\">4.5</span>\n");
      out.write("                                <div class=\"rating-stars\" id=\"overallStars\">\n");
      out.write("                                    <i class=\"fas fa-star\"></i>\n");
      out.write("                                    <i class=\"fas fa-star\"></i>\n");
      out.write("                                    <i class=\"fas fa-star\"></i>\n");
      out.write("                                    <i class=\"fas fa-star\"></i>\n");
      out.write("                                    <i class=\"fas fa-star-half-alt\"></i>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"total-reviews\" id=\"totalReviews\">(23 đánh giá)</span>\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                        <div class=\"rating-breakdown\">\n");
      out.write("                            <div class=\"rating-bar\">\n");
      out.write("                                <span class=\"rating-label\">5 sao</span>\n");
      out.write("                                <div class=\"bar-container\">\n");
      out.write("                                    <div class=\"bar-fill\" style=\"width: 60%\"></div>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"rating-count\">14</span>\n");
      out.write("                            </div>\n");
      out.write("                            <div class=\"rating-bar\">\n");
      out.write("                                <span class=\"rating-label\">4 sao</span>\n");
      out.write("                                <div class=\"bar-container\">\n");
      out.write("                                    <div class=\"bar-fill\" style=\"width: 30%\"></div>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"rating-count\">7</span>\n");
      out.write("                            </div>\n");
      out.write("                            <div class=\"rating-bar\">\n");
      out.write("                                <span class=\"rating-label\">3 sao</span>\n");
      out.write("                                <div class=\"bar-container\">\n");
      out.write("                                    <div class=\"bar-fill\" style=\"width: 8%\"></div>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"rating-count\">2</span>\n");
      out.write("                            </div>\n");
      out.write("                            <div class=\"rating-bar\">\n");
      out.write("                                <span class=\"rating-label\">2 sao</span>\n");
      out.write("                                <div class=\"bar-container\">\n");
      out.write("                                    <div class=\"bar-fill\" style=\"width: 0%\"></div>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"rating-count\">0</span>\n");
      out.write("                            </div>\n");
      out.write("                            <div class=\"rating-bar\">\n");
      out.write("                                <span class=\"rating-label\">1 sao</span>\n");
      out.write("                                <div class=\"bar-container\">\n");
      out.write("                                    <div class=\"bar-fill\" style=\"width: 2%\"></div>\n");
      out.write("                                </div>\n");
      out.write("                                <span class=\"rating-count\">0</span>\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("\n");
      out.write("                <!-- Add Review Form -->\n");
      out.write("                <div class=\"add-review\" id=\"addReviewSection\">\n");
      out.write("                    <h3 class=\"review-form-title\">\n");
      out.write("                        <i class=\"fas fa-edit me-2\"></i>Viết đánh giá\n");
      out.write("                    </h3>\n");
      out.write("                    \n");
      out.write("                    <form class=\"review-form\" id=\"reviewForm\">\n");
      out.write("                        <div class=\"rating-input mb-3\">\n");
      out.write("                            <label class=\"form-label\">Đánh giá của bạn *</label>\n");
      out.write("                            <div class=\"star-rating\" id=\"starRating\">\n");
      out.write("                                <span class=\"star\" data-rating=\"1\"><i class=\"far fa-star\"></i></span>\n");
      out.write("                                <span class=\"star\" data-rating=\"2\"><i class=\"far fa-star\"></i></span>\n");
      out.write("                                <span class=\"star\" data-rating=\"3\"><i class=\"far fa-star\"></i></span>\n");
      out.write("                                <span class=\"star\" data-rating=\"4\"><i class=\"far fa-star\"></i></span>\n");
      out.write("                                <span class=\"star\" data-rating=\"5\"><i class=\"far fa-star\"></i></span>\n");
      out.write("                            </div>\n");
      out.write("                            <input type=\"hidden\" id=\"ratingValue\" name=\"rating\" value=\"0\">\n");
      out.write("                        </div>\n");
      out.write("                        <div class=\"mb-3\">\n");
      out.write("                            <label for=\"reviewComment\" class=\"form-label\">Nội dung đánh giá *</label>\n");
      out.write("                            <textarea class=\"form-control\" id=\"reviewComment\" name=\"comment\" rows=\"4\" \n");
      out.write("                                placeholder=\"Chia sẻ trải nghiệm của bạn về sản phẩm này...\" required></textarea>\n");
      out.write("                        </div>\n");
      out.write("                        <button type=\"submit\" class=\"btn btn-primary\">\n");
      out.write("                            <i class=\"fas fa-paper-plane me-2\"></i>Gửi đánh giá\n");
      out.write("                        </button>\n");
      out.write("                    </form>\n");
      out.write("                </div>\n");
      out.write("\n");
      out.write("                <!-- Reviews List -->\n");
      out.write("                <div class=\"reviews-list\" id=\"reviewsList\">\n");
      out.write("                    <div class=\"reviews-header-controls\">\n");
      out.write("                        <h3>Tất cả đánh giá</h3>\n");
      out.write("                        <div class=\"review-filters\">\n");
      out.write("                            <select class=\"form-select\" id=\"reviewFilter\">\n");
      out.write("                                <option value=\"all\">Tất cả đánh giá</option>\n");
      out.write("                                <option value=\"5\">5 sao</option>\n");
      out.write("                                <option value=\"4\">4 sao</option>\n");
      out.write("                                <option value=\"3\">3 sao</option>\n");
      out.write("                                <option value=\"2\">2 sao</option>\n");
      out.write("                                <option value=\"1\">1 sao</option>\n");
      out.write("                            </select>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <!-- Review items sẽ được render động bằng JS từ API, xoá hết review mẫu tĩnh ở đây -->\n");
      out.write("                    <div id=\"dynamicReviews\"></div>\n");
      out.write("                    <!-- Load More Reviews -->\n");
      out.write("                    <div class=\"text-center mt-4\">\n");
      out.write("                        <button class=\"btn btn-outline-primary\" id=\"loadMoreReviews\">\n");
      out.write("                            <i class=\"fas fa-chevron-down me-2\"></i>Xem thêm đánh giá\n");
      out.write("                        </button>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("\n");
      out.write("            <!-- Related Products -->\n");
      out.write("            <div id=\"relatedProducts\" class=\"related-products\" style=\"display: none;\">\n");
      out.write("                <h2 class=\"section-title\">\n");
      out.write("                    <i class=\"fas fa-cubes me-2\"></i>Sản phẩm liên quan\n");
      out.write("                </h2>\n");
      out.write("                <div class=\"related-products-grid\" id=\"relatedProductsGrid\">\n");
      out.write("                    <!-- Related products will be inserted here -->\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("    </div>\n");
      out.write("\n");
      out.write("    <!-- Footer -->\n");
      out.write("    <footer class=\"bg-dark text-white\">\n");
      out.write("        <div class=\"footer-top py-5\">\n");
      out.write("            <div class=\"container\">\n");
      out.write("                <div class=\"row\">\n");
      out.write("                    <div class=\"col-lg-4 col-md-6 mb-4\">\n");
      out.write("                        <div class=\"footer-section\">\n");
      out.write("                            <h5 class=\"footer-title\">43 Gundam Hobby</h5>\n");
      out.write("                            <p class=\"footer-desc\">Chuyên cung cấp mô hình Gundam chính hãng với giá tốt nhất. Uy tín - Chất lượng - Dịch vụ tận tâm.</p>\n");
      out.write("                            <div class=\"store-info\">\n");
      out.write("                                <div class=\"info-item mb-2\">\n");
      out.write("                                    <i class=\"fas fa-map-marker-alt me-2\"></i>\n");
      out.write("                                    <span>59 Lê Đình Diên, Cẩm Lệ, Đà Nẵng</span>\n");
      out.write("                                </div>\n");
      out.write("                                <div class=\"info-item mb-2\">\n");
      out.write("                                    <i class=\"fas fa-phone me-2\"></i>\n");
      out.write("                                    <a href=\"tel:0385546145\" class=\"text-white\">0385546145 (8h-20h)</a>\n");
      out.write("                                </div>\n");
      out.write("                                <div class=\"info-item\">\n");
      out.write("                                    <i class=\"fas fa-envelope me-2\"></i>\n");
      out.write("                                    <a href=\"mailto:43gundamhobby@gmail.com\" class=\"text-white\">43gundamhobby@gmail.com</a>\n");
      out.write("                                </div>\n");
      out.write("                            </div>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-lg-2 col-md-6 mb-4\">\n");
      out.write("                        <div class=\"footer-section\">\n");
      out.write("                            <h6 class=\"footer-title\">Sản phẩm</h6>\n");
      out.write("                            <ul class=\"footer-links\">\n");
      out.write("                                <li><a href=\"#\">Gundam Bandai</a></li>\n");
      out.write("                                <li><a href=\"#\">High Grade (HG)</a></li>\n");
      out.write("                                <li><a href=\"#\">Master Grade (MG)</a></li>\n");
      out.write("                                <li><a href=\"#\">Real Grade (RG)</a></li>\n");
      out.write("                                <li><a href=\"#\">Perfect Grade (PG)</a></li>\n");
      out.write("                                <li><a href=\"#\">Metal Build</a></li>\n");
      out.write("                            </ul>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-lg-2 col-md-6 mb-4\">\n");
      out.write("                        <div class=\"footer-section\">\n");
      out.write("                            <h6 class=\"footer-title\">Dịch vụ</h6>\n");
      out.write("                            <ul class=\"footer-links\">\n");
      out.write("                                <li><a href=\"#\">Hàng Pre-Order</a></li>\n");
      out.write("                                <li><a href=\"#\">Dụng cụ & Phụ kiện</a></li>\n");
      out.write("                                <li><a href=\"#\">Hướng dẫn lắp ráp</a></li>\n");
      out.write("                                <li><a href=\"#\">Sơn & Trang trí</a></li>\n");
      out.write("                                <li><a href=\"#\">Bảo hành sản phẩm</a></li>\n");
      out.write("                            </ul>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-lg-2 col-md-6 mb-4\">\n");
      out.write("                        <div class=\"footer-section\">\n");
      out.write("                            <h6 class=\"footer-title\">Chính sách</h6>\n");
      out.write("                            <ul class=\"footer-links\">\n");
      out.write("                                <li><a href=\"#\">Chính sách bảo mật</a></li>\n");
      out.write("                                <li><a href=\"#\">Chính sách thanh toán</a></li>\n");
      out.write("                                <li><a href=\"#\">Chính sách vận chuyển</a></li>\n");
      out.write("                                <li><a href=\"#\">Chính sách đổi trả</a></li>\n");
      out.write("                                <li><a href=\"#\">Quy định sử dụng</a></li>\n");
      out.write("                            </ul>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-lg-2 col-md-6 mb-4\">\n");
      out.write("                        <div class=\"footer-section\">\n");
      out.write("                            <h6 class=\"footer-title\">Hỗ trợ</h6>\n");
      out.write("                            <ul class=\"footer-links\">\n");
      out.write("                                <li><a href=\"#\">Liên hệ</a></li>\n");
      out.write("                                <li><a href=\"#\">FAQ</a></li>\n");
      out.write("                                <li><a href=\"#\">Hướng dẫn đặt hàng</a></li>\n");
      out.write("                                <li><a href=\"#\">Tra cứu đơn hàng</a></li>\n");
      out.write("                                <li><a href=\"#\">Hỗ trợ kỹ thuật</a></li>\n");
      out.write("                            </ul>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("        <div class=\"footer-social py-4 bg-darker\">\n");
      out.write("            <div class=\"container\">\n");
      out.write("                <div class=\"row align-items-center\">\n");
      out.write("                    <div class=\"col-md-6\">\n");
      out.write("                        <h6 class=\"social-title mb-3\">Theo dõi chúng tôi</h6>\n");
      out.write("                        <div class=\"social-links\">\n");
      out.write("                            <a href=\"#\" class=\"social-link facebook\">\n");
      out.write("                                <i class=\"fab fa-facebook-f\"></i>\n");
      out.write("                                <span>Facebook</span>\n");
      out.write("                            </a>\n");
      out.write("                            <a href=\"#\" class=\"social-link youtube\">\n");
      out.write("                                <i class=\"fab fa-youtube\"></i>\n");
      out.write("                                <span>Youtube</span>\n");
      out.write("                            </a>\n");
      out.write("                            <a href=\"#\" class=\"social-link tiktok\">\n");
      out.write("                                <i class=\"fab fa-tiktok\"></i>\n");
      out.write("                                <span>TikTok</span>\n");
      out.write("                            </a>\n");
      out.write("                            <a href=\"#\" class=\"social-link instagram\">\n");
      out.write("                                <i class=\"fab fa-instagram\"></i>\n");
      out.write("                                <span>Instagram</span>\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-md-6\">\n");
      out.write("                        <div class=\"newsletter\">\n");
      out.write("                            <h6 class=\"newsletter-title mb-3\">Đăng ký nhận tin</h6>\n");
      out.write("                            <form class=\"newsletter-form\">\n");
      out.write("                                <div class=\"input-group\">\n");
      out.write("                                    <input type=\"email\" class=\"form-control\" placeholder=\"Nhập email của bạn...\">\n");
      out.write("                                    <button class=\"btn btn-primary\" type=\"submit\">\n");
      out.write("                                        <i class=\"fas fa-paper-plane\"></i>\n");
      out.write("                                    </button>\n");
      out.write("                                </div>\n");
      out.write("                            </form>\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("        <div class=\"footer-bottom py-3 bg-darker border-top border-secondary\">\n");
      out.write("            <div class=\"container\">\n");
      out.write("                <div class=\"row align-items-center\">\n");
      out.write("                    <div class=\"col-md-6\">\n");
      out.write("                        <p class=\"copyright mb-0\">&copy; 2025 43 Gundam Hobby. All rights reserved.</p>\n");
      out.write("                    </div>\n");
      out.write("                    <div class=\"col-md-6 text-md-end\">\n");
      out.write("                        <div class=\"payment-methods\">\n");
      out.write("                            <img src=\"https://via.placeholder.com/40x25/cccccc/666666?text=VISA\" alt=\"Visa\" class=\"payment-icon\">\n");
      out.write("                            <img src=\"https://via.placeholder.com/40x25/cccccc/666666?text=MC\" alt=\"Mastercard\" class=\"payment-icon\">\n");
      out.write("                            <img src=\"https://via.placeholder.com/40x25/cccccc/666666?text=COD\" alt=\"COD\" class=\"payment-icon\">\n");
      out.write("                        </div>\n");
      out.write("                    </div>\n");
      out.write("                </div>\n");
      out.write("            </div>\n");
      out.write("        </div>\n");
      out.write("    </footer>\n");
      out.write("    <!-- Back to Top Button -->\n");
      out.write("    <button class=\"back-to-top\" id=\"backToTop\">\n");
      out.write("        <i class=\"fas fa-chevron-up\"></i>\n");
      out.write("    </button>\n");
      out.write("\n");
      out.write("    <!-- Scripts -->\n");
      out.write("    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n");
      out.write("    \n");
      out.write("    <!-- Hamburger Menu Script -->\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/hamburger-menu.js\"></script>\n");
      out.write("    \n");
      out.write("    <!-- Product Detail Script -->\n");
      out.write("    <script>\n");
      out.write("        // Product ID from server\n");
      out.write("        const productId = '");
      out.print( productId );
      out.write("';\n");
      out.write("        const contextPath = '");
      out.print( request.getContextPath() );
      out.write("';\n");
      out.write("        \n");
      out.write("        // Load product data when page loads\n");
      out.write("        document.addEventListener('DOMContentLoaded', function() {\n");
      out.write("            // Log product ID for debugging\n");
      out.write("            console.log('Product ID from JSP:', productId);\n");
      out.write("            console.log('Context path:', contextPath);\n");
      out.write("            \n");
      out.write("            // Load product data first\n");
      out.write("            loadProductData();\n");
      out.write("            \n");
      out.write("            // Setup event listeners\n");
      out.write("            setupEventListeners();\n");
      out.write("            \n");
      out.write("            // Ensure reviews load after page is ready - with multiple attempts for robustness\n");
      out.write("            setTimeout(() => {\n");
      out.write("                console.log('Loading reviews (first attempt)...');\n");
      out.write("                loadProductReviews(productId);\n");
      out.write("            }, 500);\n");
      out.write("            \n");
      out.write("            // Backup attempt in case first one fails\n");
      out.write("            setTimeout(() => {\n");
      out.write("                console.log('Loading reviews (backup attempt)...');\n");
      out.write("                const dynamicReviews = document.getElementById('dynamicReviews');\n");
      out.write("                if (dynamicReviews && dynamicReviews.innerHTML.trim() === '') {\n");
      out.write("                    console.log('No reviews loaded yet, trying again...');\n");
      out.write("                    loadProductReviews(productId);\n");
      out.write("                }\n");
      out.write("            }, 2000);\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("        // Load product data from API\n");
      out.write("        async function loadProductData() {\n");
      out.write("            try {\n");
      out.write("                const response = await fetch(contextPath + '/api/products/' + productId);\n");
      out.write("                const data = await response.json();\n");
      out.write("                \n");
      out.write("                if (data.success && data.data) {\n");
      out.write("                    displayProduct(data.data);\n");
      out.write("                    document.getElementById('loadingState').style.display = 'none';\n");
      out.write("                    \n");
      out.write("                    // Load reviews for this product\n");
      out.write("                    loadProductReviews(productId);\n");
      out.write("                } else {\n");
      out.write("                    showError(data.message || 'Không tìm thấy sản phẩm');\n");
      out.write("                }\n");
      out.write("            } catch (error) {\n");
      out.write("                console.error('Error loading product:', error);\n");
      out.write("                showError('Có lỗi xảy ra khi tải thông tin sản phẩm');\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display product information\n");
      out.write("        function displayProduct(product) {\n");
      out.write("            // Update page title and breadcrumb\n");
      out.write("            document.title = product.name + ' - 43 Gundam Hobby';\n");
      out.write("            document.getElementById('productBreadcrumb').textContent = product.name;\n");
      out.write("            \n");
      out.write("            // Display main product info\n");
      out.write("            document.getElementById('productTitle').textContent = product.name;\n");
      out.write("            \n");
      out.write("            // Display product image\n");
      out.write("            const defaultImage = contextPath + '/img/RGStrikeGundam.jpg';\n");
      out.write("            const productImage = product.imageUrl || defaultImage;\n");
      out.write("            document.getElementById('mainProductImg').src = productImage;\n");
      out.write("            document.getElementById('mainProductImg').alt = product.name;\n");
      out.write("            \n");
      out.write("            // Display product meta\n");
      out.write("            displayProductMeta(product);\n");
      out.write("            \n");
      out.write("            // Display price\n");
      out.write("            displayProductPrice(product);\n");
      out.write("            \n");
      out.write("            // Display stock status\n");
      out.write("            displayStockStatus(product);\n");
      out.write("            \n");
      out.write("            // Display description\n");
      out.write("            displayProductDescription(product);\n");
      out.write("            \n");
      out.write("            // Display specifications\n");
      out.write("            displayProductSpecifications(product);\n");
      out.write("            \n");
      out.write("            // Load related products\n");
      out.write("            loadRelatedProducts(product);\n");
      out.write("            \n");
      out.write("            // Show all sections\n");
      out.write("            document.getElementById('productMain').style.display = 'block';\n");
      out.write("            document.getElementById('productDescription').style.display = 'block';\n");
      out.write("            document.getElementById('productSpecifications').style.display = 'block';\n");
      out.write("            \n");
      out.write("            // Load wishlist status for this product\n");
      out.write("            loadWishlistStatus();\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display product meta information\n");
      out.write("        function displayProductMeta(product) {\n");
      out.write("            let metaHtml = '';\n");
      out.write("            \n");
      out.write("            if (product.category) {\n");
      out.write("                metaHtml += '<div class=\"product-category\"><i class=\"fas fa-tag\"></i><span>' + getCategoryDisplayName(product.category) + '</span></div>';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            if (product.grade) {\n");
      out.write("                metaHtml += '<div class=\"product-grade\"><i class=\"fas fa-star\"></i><span>' + product.grade + '</span></div>';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            if (product.brand) {\n");
      out.write("                metaHtml += '<div class=\"product-brand\"><i class=\"fas fa-industry\"></i><span>' + product.brand + '</span></div>';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            document.getElementById('productMeta').innerHTML = metaHtml;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display product price\n");
      out.write("        function displayProductPrice(product) {\n");
      out.write("            const price = parseFloat(product.price);\n");
      out.write("            const formattedPrice = new Intl.NumberFormat('vi-VN', {\n");
      out.write("                style: 'currency',\n");
      out.write("                currency: 'VND'\n");
      out.write("            }).format(price);\n");
      out.write("            \n");
      out.write("            const priceHtml = '<div class=\"current-price\">' + formattedPrice + '</div>';\n");
      out.write("            document.getElementById('productPrice').innerHTML = priceHtml;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display stock status\n");
      out.write("        function displayStockStatus(product) {\n");
      out.write("            const stock = parseInt(product.stockQuantity);\n");
      out.write("            let statusClass, statusIcon, statusText;\n");
      out.write("            \n");
      out.write("            if (stock > 10) {\n");
      out.write("                statusClass = 'in-stock';\n");
      out.write("                statusIcon = 'fas fa-check-circle';\n");
      out.write("                statusText = 'Còn hàng';\n");
      out.write("            } else if (stock > 0) {\n");
      out.write("                statusClass = 'low-stock';\n");
      out.write("                statusIcon = 'fas fa-exclamation-triangle';\n");
      out.write("                statusText = 'Chỉ còn ' + stock + ' sản phẩm';\n");
      out.write("            } else {\n");
      out.write("                statusClass = 'out-of-stock';\n");
      out.write("                statusIcon = 'fas fa-times-circle';\n");
      out.write("                statusText = 'Hết hàng';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            const statusHtml = '<i class=\"' + statusIcon + '\"></i><span>' + statusText + '</span>';\n");
      out.write("            \n");
      out.write("            const statusElement = document.getElementById('stockStatus');\n");
      out.write("            statusElement.className = 'stock-status ' + statusClass;\n");
      out.write("            statusElement.innerHTML = statusHtml;\n");
      out.write("            \n");
      out.write("            // Update quantity input max value\n");
      out.write("            const qtyInput = document.getElementById('quantityInput');\n");
      out.write("            qtyInput.max = Math.max(1, stock);\n");
      out.write("            \n");
      out.write("            // Disable buttons if out of stock\n");
      out.write("            const addToCartBtn = document.getElementById('addToCartBtn');\n");
      out.write("            const buyNowBtn = document.getElementById('buyNowBtn');\n");
      out.write("            \n");
      out.write("            if (stock <= 0) {\n");
      out.write("                addToCartBtn.disabled = true;\n");
      out.write("                addToCartBtn.innerHTML = '<i class=\"fas fa-times me-2\"></i>Hết hàng';\n");
      out.write("                buyNowBtn.disabled = true;\n");
      out.write("                buyNowBtn.innerHTML = '<i class=\"fas fa-times me-2\"></i>Hết hàng';\n");
      out.write("                qtyInput.disabled = true;\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display product description\n");
      out.write("        function displayProductDescription(product) {\n");
      out.write("            const description = product.description || 'Chưa có mô tả chi tiết cho sản phẩm này.';\n");
      out.write("            document.getElementById('descriptionContent').innerHTML = '<p>' + description + '</p>';\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display product specifications\n");
      out.write("        function displayProductSpecifications(product) {\n");
      out.write("            const specs = [\n");
      out.write("                { label: 'Tên sản phẩm', value: product.name },\n");
      out.write("                { label: 'Thương hiệu', value: product.brand || 'N/A' },\n");
      out.write("                { label: 'Danh mục', value: getCategoryDisplayName(product.category) },\n");
      out.write("                { label: 'Cấp độ', value: product.grade || 'N/A' },\n");
      out.write("                { label: 'Tình trạng', value: product.isActive ? 'Đang bán' : 'Ngừng bán' },\n");
      out.write("                { label: 'Số lượng tồn kho', value: product.stockQuantity || 0 }\n");
      out.write("            ];\n");
      out.write("            \n");
      out.write("            let specHtml = '';\n");
      out.write("            specs.forEach(spec => {\n");
      out.write("                specHtml += '<tr><th>' + spec.label + '</th><td>' + spec.value + '</td></tr>';\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            document.getElementById('specTableBody').innerHTML = specHtml;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Load related products\n");
      out.write("        async function loadRelatedProducts(product) {\n");
      out.write("            try {\n");
      out.write("                let relatedProducts = [];\n");
      out.write("                \n");
      out.write("                // Try to get products from same category\n");
      out.write("                if (product.category) {\n");
      out.write("                    const response = await fetch(contextPath + '/api/products/category/' + product.category);\n");
      out.write("                    const data = await response.json();\n");
      out.write("                    \n");
      out.write("                    if (data.success && data.data) {\n");
      out.write("                        relatedProducts = data.data.filter(p => p.id !== product.id).slice(0, 8);\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                // If not enough, get latest products\n");
      out.write("                if (relatedProducts.length < 4) {\n");
      out.write("                    const response = await fetch(contextPath + '/api/products/latest?limit=8');\n");
      out.write("                    const data = await response.json();\n");
      out.write("                    \n");
      out.write("                    if (data.success && data.data) {\n");
      out.write("                        const latestProducts = data.data.filter(p => p.id !== product.id);\n");
      out.write("                        relatedProducts = [...relatedProducts, ...latestProducts].slice(0, 8);\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                if (relatedProducts.length > 0) {\n");
      out.write("                    displayRelatedProducts(relatedProducts);\n");
      out.write("                    document.getElementById('relatedProducts').style.display = 'block';\n");
      out.write("                }\n");
      out.write("            } catch (error) {\n");
      out.write("                console.error('Error loading related products:', error);\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Display related products\n");
      out.write("        function displayRelatedProducts(products) {\n");
      out.write("            let html = '';\n");
      out.write("            products.forEach(product => {\n");
      out.write("                const price = parseFloat(product.price);\n");
      out.write("                const formattedPrice = new Intl.NumberFormat('vi-VN', {\n");
      out.write("                    style: 'currency',\n");
      out.write("                    currency: 'VND'\n");
      out.write("                }).format(price);\n");
      out.write("                \n");
      out.write("                const defaultImage = contextPath + '/img/RGStrikeGundam.jpg';\n");
      out.write("                const productImage = product.imageUrl || defaultImage;\n");
      out.write("                \n");
      out.write("                html += '<div class=\"related-product-card\">' +\n");
      out.write("                    '<div class=\"related-product-image\">' +\n");
      out.write("                        '<img src=\"' + productImage + '\" alt=\"' + product.name + '\" onerror=\"this.src=\\'' + defaultImage + '\\'\">' +\n");
      out.write("                    '</div>' +\n");
      out.write("                    '<div class=\"related-product-info\">' +\n");
      out.write("                        '<h6 class=\"related-product-title\">' + product.name + '</h6>' +\n");
      out.write("                        '<div class=\"related-product-price\">' + formattedPrice + '</div>' +\n");
      out.write("                        '<button class=\"related-product-btn\" onclick=\"window.location.href=\\'' + contextPath + '/product-detail.jsp?id=' + product.id + '\\'\">' +\n");
      out.write("                            '<i class=\"fas fa-eye me-1\"></i>Xem chi tiết' +\n");
      out.write("                        '</button>' +\n");
      out.write("                    '</div>' +\n");
      out.write("                '</div>';\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            document.getElementById('relatedProductsGrid').innerHTML = html;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Show error message\n");
      out.write("        function showError(message) {\n");
      out.write("            document.getElementById('loadingState').style.display = 'none';\n");
      out.write("            document.getElementById('errorMessage').textContent = message;\n");
      out.write("            document.getElementById('errorState').style.display = 'block';\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Get category display name\n");
      out.write("        function getCategoryDisplayName(category) {\n");
      out.write("            const categoryNames = {\n");
      out.write("                'GUNDAM_BANDAI': 'Gundam Bandai',\n");
      out.write("                'PRE_ORDER': 'Pre-Order',\n");
      out.write("                'TOOLS_ACCESSORIES': 'Dụng cụ & Phụ kiện'\n");
      out.write("            };\n");
      out.write("            return categoryNames[category] || category;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Setup event listeners\n");
      out.write("        function setupEventListeners() {\n");
      out.write("            // Quantity controls\n");
      out.write("            document.getElementById('decreaseQty').addEventListener('click', function() {\n");
      out.write("                const input = document.getElementById('quantityInput');\n");
      out.write("                const currentValue = parseInt(input.value);\n");
      out.write("                if (currentValue > parseInt(input.min)) {\n");
      out.write("                    input.value = currentValue - 1;\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            document.getElementById('increaseQty').addEventListener('click', function() {\n");
      out.write("                const input = document.getElementById('quantityInput');\n");
      out.write("                const currentValue = parseInt(input.value);\n");
      out.write("                if (currentValue < parseInt(input.max)) {\n");
      out.write("                    input.value = currentValue + 1;\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            // Add to cart button\n");
      out.write("            document.getElementById('addToCartBtn').addEventListener('click', function() {\n");
      out.write("                const quantity = document.getElementById('quantityInput').value;\n");
      out.write("                fetch(contextPath + '/api/cart/add', {\n");
      out.write("                    method: 'POST',\n");
      out.write("                    headers: { 'Content-Type': 'application/json' },\n");
      out.write("                    credentials: 'same-origin',\n");
      out.write("                    body: JSON.stringify({ productId: Number(productId), quantity: Number(quantity) })\n");
      out.write("                })\n");
      out.write("                .then(res => res.json())\n");
      out.write("                .then(data => {\n");
      out.write("                    if (data.success) {\n");
      out.write("                        this.innerHTML = '<i class=\"fas fa-check me-2\"></i>Đã thêm vào giỏ';\n");
      out.write("                        this.classList.add('btn-success');\n");
      out.write("                        this.classList.remove('btn-add-cart');\n");
      out.write("                    } else {\n");
      out.write("                        alert(data.message || 'Có lỗi xảy ra!');\n");
      out.write("                    }\n");
      out.write("                    setTimeout(() => {\n");
      out.write("                        this.innerHTML = '<i class=\"fas fa-cart-plus me-2\"></i>Thêm vào giỏ hàng';\n");
      out.write("                        this.classList.remove('btn-success');\n");
      out.write("                        this.classList.add('btn-add-cart');\n");
      out.write("                    }, 2000);\n");
      out.write("                })\n");
      out.write("                .catch(() => {\n");
      out.write("                    alert('Không thể thêm vào giỏ hàng. Vui lòng thử lại!');\n");
      out.write("                });\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            // Buy now button\n");
      out.write("            document.getElementById('buyNowBtn').addEventListener('click', function() {\n");
      out.write("                const quantity = document.getElementById('quantityInput').value;\n");
      out.write("                // Add your buy now logic here\n");
      out.write("                alert(`Mua ngay ");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${quantity}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write(" sản phẩm`);\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            // Wishlist button\n");
      out.write("            document.getElementById('wishlistBtn').addEventListener('click', function() {\n");
      out.write("                toggleWishlist();\n");
      out.write("            });\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Back to top functionality\n");
      out.write("        const backToTopBtn = document.getElementById('backToTop');\n");
      out.write("        \n");
      out.write("        window.addEventListener('scroll', () => {\n");
      out.write("            if (window.pageYOffset > 300) {\n");
      out.write("                backToTopBtn.classList.add('show');\n");
      out.write("            } else {\n");
      out.write("                backToTopBtn.classList.remove('show');\n");
      out.write("            }\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("        backToTopBtn.addEventListener('click', () => {\n");
      out.write("            window.scrollTo({\n");
      out.write("                top: 0,\n");
      out.write("                behavior: 'smooth'\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("        // ===== TOAST NOTIFICATION FUNCTION =====\n");
      out.write("        \n");
      out.write("        function showToast(message, type = 'success', duration = 3000) {\n");
      out.write("            // Remove existing toast if any\n");
      out.write("            const existingToast = document.querySelector('.toast-notification');\n");
      out.write("            if (existingToast) {\n");
      out.write("                existingToast.remove();\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Create toast element\n");
      out.write("            const toast = document.createElement('div');\n");
      out.write("            toast.className = `toast-notification toast-");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${type}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("`;\n");
      out.write("            \n");
      out.write("            // Set toast content based on type\n");
      out.write("            let icon = '';\n");
      out.write("            switch (type) {\n");
      out.write("                case 'success':\n");
      out.write("                    icon = '<i class=\"fas fa-check-circle\"></i>';\n");
      out.write("                    break;\n");
      out.write("                case 'error':\n");
      out.write("                    icon = '<i class=\"fas fa-exclamation-circle\"></i>';\n");
      out.write("                    break;\n");
      out.write("                case 'warning':\n");
      out.write("                    icon = '<i class=\"fas fa-exclamation-triangle\"></i>';\n");
      out.write("                    break;\n");
      out.write("                case 'info':\n");
      out.write("                    icon = '<i class=\"fas fa-info-circle\"></i>';\n");
      out.write("                    break;\n");
      out.write("                default:\n");
      out.write("                    icon = '<i class=\"fas fa-check-circle\"></i>';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            toast.innerHTML = `\n");
      out.write("                <div class=\"toast-content\">\n");
      out.write("                    ");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${icon}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("<span class=\"toast-message\">");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${message}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("</span>\n");
      out.write("                </div>\n");
      out.write("                <button class=\"toast-close\" onclick=\"this.parentElement.remove()\">\n");
      out.write("                    <i class=\"fas fa-times\"></i>\n");
      out.write("                </button>\n");
      out.write("            `;\n");
      out.write("            \n");
      out.write("            // Add toast to body\n");
      out.write("            document.body.appendChild(toast);\n");
      out.write("            \n");
      out.write("            // Show toast with animation\n");
      out.write("            setTimeout(() => {\n");
      out.write("                toast.classList.add('show');\n");
      out.write("            }, 100);\n");
      out.write("            \n");
      out.write("            // Auto hide toast after duration\n");
      out.write("            setTimeout(() => {\n");
      out.write("                toast.classList.remove('show');\n");
      out.write("                setTimeout(() => {\n");
      out.write("                    if (toast.parentNode) {\n");
      out.write("                        toast.remove();\n");
      out.write("                    }\n");
      out.write("                }, 300);\n");
      out.write("            }, duration);\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // ===== WISHLIST FUNCTIONALITY =====\n");
      out.write("        \n");
      out.write("        // Initialize wishlist state\n");
      out.write("        let isInWishlist = false;\n");
      out.write("        \n");
      out.write("        // Load wishlist status for current product\n");
      out.write("        async function loadWishlistStatus() {\n");
      out.write("            try {\n");
      out.write("                const sessionUserId = getUserIdFromSession();\n");
      out.write("                if (!sessionUserId) {\n");
      out.write("                    return; // User not logged in\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                const response = await fetch(contextPath + '/api/favorites/check?productId=' + productId, {\n");
      out.write("                    method: 'GET',\n");
      out.write("                    credentials: 'same-origin'\n");
      out.write("                });\n");
      out.write("                \n");
      out.write("                if (response.ok) {\n");
      out.write("                    const data = await response.json();\n");
      out.write("                    if (data.success) {\n");
      out.write("                        isInWishlist = data.inWishlist;\n");
      out.write("                        updateWishlistButton();\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("            } catch (error) {\n");
      out.write("                console.error('Error loading wishlist status:', error);\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Update wishlist button appearance\n");
      out.write("        function updateWishlistButton() {\n");
      out.write("            const wishlistBtn = document.getElementById('wishlistBtn');\n");
      out.write("            const icon = wishlistBtn.querySelector('i');\n");
      out.write("            \n");
      out.write("            if (isInWishlist) {\n");
      out.write("                icon.classList.remove('far');\n");
      out.write("                icon.classList.add('fas');\n");
      out.write("                wishlistBtn.style.color = '#e74c3c';\n");
      out.write("                wishlistBtn.title = 'Xóa khỏi danh sách yêu thích';\n");
      out.write("            } else {\n");
      out.write("                icon.classList.remove('fas');\n");
      out.write("                icon.classList.add('far');\n");
      out.write("                wishlistBtn.style.color = '';\n");
      out.write("                wishlistBtn.title = 'Thêm vào danh sách yêu thích';\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Toggle wishlist status\n");
      out.write("        async function toggleWishlist() {\n");
      out.write("            try {\n");
      out.write("                const sessionUserId = getUserIdFromSession();\n");
      out.write("                if (!sessionUserId) {\n");
      out.write("                    showToast('Vui lòng đăng nhập để sử dụng tính năng yêu thích!', 'warning');\n");
      out.write("                    setTimeout(() => {\n");
      out.write("                        window.location.href = contextPath + '/login.jsp?redirect=' + encodeURIComponent(window.location.href);\n");
      out.write("                    }, 1500);\n");
      out.write("                    return;\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                const wishlistBtn = document.getElementById('wishlistBtn');\n");
      out.write("                const originalContent = wishlistBtn.innerHTML;\n");
      out.write("                \n");
      out.write("                // Show loading state\n");
      out.write("                wishlistBtn.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';\n");
      out.write("                wishlistBtn.disabled = true;\n");
      out.write("                \n");
      out.write("                const endpoint = isInWishlist ? 'remove' : 'add';\n");
      out.write("                const response = await fetch(contextPath + '/api/favorites/' + endpoint, {\n");
      out.write("                    method: 'POST',\n");
      out.write("                    headers: {\n");
      out.write("                        'Content-Type': 'application/json',\n");
      out.write("                    },\n");
      out.write("                    credentials: 'same-origin',\n");
      out.write("                    body: JSON.stringify({\n");
      out.write("                        productId: parseInt(productId),\n");
      out.write("                        userId: sessionUserId\n");
      out.write("                    })\n");
      out.write("                });\n");
      out.write("                \n");
      out.write("                const data = await response.json();\n");
      out.write("                \n");
      out.write("                if (response.ok && data.success) {\n");
      out.write("                    isInWishlist = !isInWishlist;\n");
      out.write("                    updateWishlistButton();\n");
      out.write("                    \n");
      out.write("                    const message = isInWishlist ? \n");
      out.write("                        'Đã thêm vào danh sách yêu thích!' : \n");
      out.write("                        'Đã xóa khỏi danh sách yêu thích!';\n");
      out.write("                    showToast(message, 'success');\n");
      out.write("                } else {\n");
      out.write("                    const errorMessage = data.message || 'Có lỗi xảy ra. Vui lòng thử lại!';\n");
      out.write("                    showToast(errorMessage, 'error');\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("            } catch (error) {\n");
      out.write("                console.error('Error toggling wishlist:', error);\n");
      out.write("                showToast('Có lỗi xảy ra. Vui lòng thử lại!', 'error');\n");
      out.write("            } finally {\n");
      out.write("                // Restore button state\n");
      out.write("                const wishlistBtn = document.getElementById('wishlistBtn');\n");
      out.write("                wishlistBtn.innerHTML = '<i class=\"far fa-heart\"></i>';\n");
      out.write("                wishlistBtn.disabled = false;\n");
      out.write("                updateWishlistButton();\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        // ===== REVIEW FUNCTIONALITY =====\n");
      out.write("        \n");
      out.write("        // Star Rating Functionality\n");
      out.write("        const starRating = document.getElementById('starRating');\n");
      out.write("        const ratingValue = document.getElementById('ratingValue');\n");
      out.write("        const stars = starRating.querySelectorAll('.star');\n");
      out.write("        \n");
      out.write("        stars.forEach((star, index) => {\n");
      out.write("            star.addEventListener('mouseenter', () => {\n");
      out.write("                highlightStars(index + 1);\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            star.addEventListener('mouseleave', () => {\n");
      out.write("                highlightStars(parseInt(ratingValue.value));\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            star.addEventListener('click', () => {\n");
      out.write("                const rating = index + 1;\n");
      out.write("                ratingValue.value = rating;\n");
      out.write("                highlightStars(rating);\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("        function highlightStars(rating) {\n");
      out.write("            stars.forEach((star, index) => {\n");
      out.write("                const icon = star.querySelector('i');\n");
      out.write("                if (index < rating) {\n");
      out.write("                    star.classList.add('active');\n");
      out.write("                    icon.className = 'fas fa-star';\n");
      out.write("                } else {\n");
      out.write("                    star.classList.remove('active');\n");
      out.write("                    icon.className = 'far fa-star';\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Review Form Submission\n");
      out.write("        const reviewForm = document.getElementById('reviewForm');\n");
      out.write("        reviewForm.addEventListener('submit', async (e) => {\n");
      out.write("            e.preventDefault();\n");
      out.write("            \n");
      out.write("            // Kiểm tra đăng nhập từ JSP session trực tiếp\n");
      out.write("            const sessionUserId = getUserIdFromSession();\n");
      out.write("            console.log('User ID from JSP session:', sessionUserId);\n");
      out.write("            \n");
      out.write("            if (!sessionUserId || sessionUserId === 'null') {\n");
      out.write("                const confirmLogin = confirm('Bạn cần đăng nhập để gửi đánh giá. Chuyển đến trang đăng nhập?');\n");
      out.write("                if (confirmLogin) {\n");
      out.write("                    window.location.href = contextPath + '/login.jsp?redirect=' + encodeURIComponent(window.location.href);\n");
      out.write("                }\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            const rating = parseInt(ratingValue.value);\n");
      out.write("            if (rating === 0) {\n");
      out.write("                alert('Vui lòng chọn số sao đánh giá!');\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            const formData = new FormData(reviewForm);\n");
      out.write("            const comment = formData.get('comment')?.trim();\n");
      out.write("            \n");
      out.write("            if (!comment) {\n");
      out.write("                alert('Vui lòng nhập nội dung đánh giá!');\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            const reviewData = {\n");
      out.write("                productId: parseInt(productId),\n");
      out.write("                userId: sessionUserId, // Gửi userId từ session\n");
      out.write("                rating: rating,\n");
      out.write("                comment: comment,\n");
      out.write("                isVerified: false\n");
      out.write("            };\n");
      out.write("            \n");
      out.write("            console.log('Sending review data:', reviewData);\n");
      out.write("            console.log('Product ID for review:', productId);\n");
      out.write("            console.log('Product ID type:', typeof productId);\n");
      out.write("            console.log('Product ID is empty?', !productId || productId.trim() === '');\n");
      out.write("            console.log('JSESSIONID cookie exists:', document.cookie.includes('JSESSIONID'));\n");
      out.write("            \n");
      out.write("            // Kiểm tra productId trước khi tạo URL\n");
      out.write("            if (!productId || productId.trim() === '' || productId === 'null' || productId === 'undefined') {\n");
      out.write("                alert('Lỗi: Không tìm thấy ID sản phẩm. Vui lòng reload trang!');\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            try {\n");
      out.write("                const submitButton = reviewForm.querySelector('button[type=\"submit\"]');\n");
      out.write("                const originalButtonText = submitButton.innerHTML;\n");
      out.write("                submitButton.disabled = true;\n");
      out.write("                \n");
      out.write("                // Hiển thị trạng thái loading chi tiết hơn\n");
      out.write("                let loadingStep = 1;\n");
      out.write("                const loadingMessages = [\n");
      out.write("                    'Đang gửi đánh giá...',\n");
      out.write("                    'Đang kiểm tra quyền đánh giá...',\n");
      out.write("                    'Đang xử lý đánh giá...',\n");
      out.write("                    'Gần hoàn thành...'\n");
      out.write("                ];\n");
      out.write("                \n");
      out.write("                const updateLoadingMessage = () => {\n");
      out.write("                    if (loadingStep < loadingMessages.length) {\n");
      out.write("                        submitButton.innerHTML = `<i class=\"fas fa-spinner fa-spin me-2\"></i>");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${loadingMessages[loadingStep - 1]}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("`;\n");
      out.write("                        loadingStep++;\n");
      out.write("                    }\n");
      out.write("                };\n");
      out.write("                \n");
      out.write("                updateLoadingMessage();\n");
      out.write("                const loadingInterval = setInterval(updateLoadingMessage, 10000); // Cập nhật message mỗi 10 giây\n");
      out.write("                \n");
      out.write("                const reviewUrl = contextPath + '/api/reviews/product/' + productId.trim();\n");
      out.write("                console.log('Review submission URL:', reviewUrl);\n");
      out.write("                console.log('Final URL parts - contextPath:', contextPath, 'productId:', productId.trim());\n");
      out.write("                \n");
      out.write("                // Tạo timeout controller để kiểm soát thời gian chờ\n");
      out.write("                const controller = new AbortController();\n");
      out.write("                const timeoutId = setTimeout(() => {\n");
      out.write("                    controller.abort();\n");
      out.write("                    console.log('Review submission timed out after 45 seconds');\n");
      out.write("                }, 45000); // Tăng timeout lên 45 giây\n");
      out.write("                \n");
      out.write("                const response = await fetch(reviewUrl, {\n");
      out.write("                    method: 'POST',\n");
      out.write("                    headers: { \n");
      out.write("                        'Content-Type': 'application/json',\n");
      out.write("                        'Accept': 'application/json'\n");
      out.write("                    },\n");
      out.write("                    credentials: 'same-origin', // Đảm bảo gửi cookie session\n");
      out.write("                    body: JSON.stringify(reviewData),\n");
      out.write("                    signal: controller.signal // Thêm signal để có thể cancel request\n");
      out.write("                });\n");
      out.write("                \n");
      out.write("                // Clear timeout nếu request hoàn thành\n");
      out.write("                clearTimeout(timeoutId);\n");
      out.write("                clearInterval(loadingInterval); // Clear loading interval\n");
      out.write("                \n");
      out.write("                console.log('Review submission response status:', response.status);\n");
      out.write("                console.log('Response headers:', Array.from(response.headers.entries()));\n");
      out.write("                \n");
      out.write("                // Đọc response text trước để debug\n");
      out.write("                const responseText = await response.text();\n");
      out.write("                console.log('Raw response text:', responseText);\n");
      out.write("                \n");
      out.write("                if (!response.ok) {\n");
      out.write("                    console.error('HTTP error! status:', response.status, 'response:', responseText);\n");
      out.write("                    throw new Error('HTTP error! status: ' + response.status + ' - ' + responseText);\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                // Parse JSON từ text\n");
      out.write("                let result;\n");
      out.write("                try {\n");
      out.write("                    result = JSON.parse(responseText);\n");
      out.write("                } catch (parseError) {\n");
      out.write("                    console.error('JSON parse error:', parseError, 'Raw text:', responseText);\n");
      out.write("                    throw new Error('Lỗi phản hồi từ server không hợp lệ');\n");
      out.write("                }\n");
      out.write("                console.log('Review submission result:', result);\n");
      out.write("                \n");
      out.write("                if (result.success) {\n");
      out.write("                    // Hiển thị thông báo thành công\n");
      out.write("                    const successAlert = document.createElement('div');\n");
      out.write("                    successAlert.className = 'alert alert-success alert-dismissible fade show';\n");
      out.write("                    successAlert.innerHTML = `\n");
      out.write("                        <i class=\"fas fa-check-circle me-2\"></i>Cảm ơn bạn đã đánh giá sản phẩm!\n");
      out.write("                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n");
      out.write("                    `;\n");
      out.write("                    reviewForm.insertAdjacentElement('beforebegin', successAlert);\n");
      out.write("                    \n");
      out.write("                    // Reset form\n");
      out.write("                    reviewForm.reset();\n");
      out.write("                    ratingValue.value = '0';\n");
      out.write("                    highlightStars(0);\n");
      out.write("                    \n");
      out.write("                    // Reload reviews after a short delay\n");
      out.write("                    setTimeout(() => {\n");
      out.write("                        loadProductReviews(productId);\n");
      out.write("                    }, 1000);\n");
      out.write("                    \n");
      out.write("                    // Tự động ẩn thông báo sau 5 giây\n");
      out.write("                    setTimeout(() => {\n");
      out.write("                        successAlert.remove();\n");
      out.write("                    }, 5000);\n");
      out.write("                } else {\n");
      out.write("                    throw new Error(result.message || 'Không thể gửi đánh giá');\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("            } catch (error) {\n");
      out.write("                // Clear loading interval nếu có lỗi\n");
      out.write("                if (typeof loadingInterval !== 'undefined') {\n");
      out.write("                    clearInterval(loadingInterval);\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                console.error('Error submitting review:', error);\n");
      out.write("                let errorMessage = error.message || 'Có lỗi xảy ra khi gửi đánh giá. Vui lòng thử lại!';\n");
      out.write("                \n");
      out.write("                // Xử lý các loại lỗi khác nhau\n");
      out.write("                if (error.name === 'AbortError' || error.message.includes('timed out')) {\n");
      out.write("                    errorMessage = 'Yêu cầu gửi đánh giá bị timeout. Vui lòng thử lại sau.';\n");
      out.write("                } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {\n");
      out.write("                    errorMessage = 'Lỗi kết nối mạng. Vui lòng kiểm tra kết nối internet và thử lại.';\n");
      out.write("                } else if (error.message.includes('chỉ có thể đánh giá') || error.message.includes('only review products')) {\n");
      out.write("                    errorMessage = 'Bạn chỉ có thể đánh giá những sản phẩm đã mua và được giao thành công.';\n");
      out.write("                } else if (error.message.includes('đăng nhập') || error.message.includes('login')) {\n");
      out.write("                    errorMessage = 'Vui lòng đăng nhập để có thể gửi đánh giá.';\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                // Xử lý các loại lỗi khác nhau\n");
      out.write("                if (error.message && error.message.includes('chỉ có thể đánh giá sản phẩm đã mua')) {\n");
      out.write("                    errorMessage = `\n");
      out.write("                        <div>\n");
      out.write("                            <p class=\"mb-2\">Bạn chỉ có thể đánh giá sản phẩm đã mua.</p>\n");
      out.write("                            <a href=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${contextPath}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("/order-history.jsp\" class=\"btn btn-sm btn-primary\">\n");
      out.write("                                <i class=\"fas fa-shopping-bag me-1\"></i>Xem lịch sử mua hàng\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    `;\n");
      out.write("                } else if (error.message && error.message.includes('purchased')) {\n");
      out.write("                    // Xử lý lỗi tiếng Anh\n");
      out.write("                    errorMessage = `\n");
      out.write("                        <div>\n");
      out.write("                            <p class=\"mb-2\">Bạn chỉ có thể đánh giá sản phẩm đã mua.</p>\n");
      out.write("                            <a href=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${contextPath}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("/order-history.jsp\" class=\"btn btn-sm btn-primary\">\n");
      out.write("                                <i class=\"fas fa-shopping-bag me-1\"></i>Xem lịch sử mua hàng\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    `;\n");
      out.write("                } else if (response.status === 403 || response.status === 400) {\n");
      out.write("                    // Lỗi không có quyền hoặc bad request - có thể là chưa mua hàng\n");
      out.write("                    errorMessage = `\n");
      out.write("                        <div>\n");
      out.write("                            <p class=\"mb-2\">Bạn chỉ có thể đánh giá sản phẩm đã mua.</p>\n");
      out.write("                            <a href=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${contextPath}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("/order-history.jsp\" class=\"btn btn-sm btn-primary\">\n");
      out.write("                                <i class=\"fas fa-shopping-bag me-1\"></i>Xem lịch sử mua hàng\n");
      out.write("                            </a>\n");
      out.write("                        </div>\n");
      out.write("                    `;\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                const errorAlert = document.createElement('div');\n");
      out.write("                errorAlert.className = 'alert alert-danger alert-dismissible fade show';\n");
      out.write("                errorAlert.innerHTML = `\n");
      out.write("                    <i class=\"fas fa-exclamation-circle me-2\"></i>");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${errorMessage}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n");
      out.write("                `;\n");
      out.write("                reviewForm.insertAdjacentElement('beforebegin', errorAlert);\n");
      out.write("                \n");
      out.write("                // Tự động ẩn thông báo lỗi sau 5 giây\n");
      out.write("                setTimeout(() => {\n");
      out.write("                    errorAlert.remove();\n");
      out.write("                }, 5000);\n");
      out.write("            } finally {\n");
      out.write("                // Clear loading interval nếu vẫn đang chạy\n");
      out.write("                if (typeof loadingInterval !== 'undefined') {\n");
      out.write("                    clearInterval(loadingInterval);\n");
      out.write("                }\n");
      out.write("                // Khôi phục nút submit\n");
      out.write("                const submitButton = reviewForm.querySelector('button[type=\"submit\"]');\n");
      out.write("                submitButton.disabled = false;\n");
      out.write("                submitButton.innerHTML = originalButtonText;\n");
      out.write("            }\n");
      out.write("        });\n");
      out.write("\n");
      out.write("        // Hàm lấy ID người dùng hiện tại\n");
      out.write("        async function getCurrentUserId() {\n");
      out.write("            try {\n");
      out.write("                // Lấy userId từ session thông qua API\n");
      out.write("                const response = await fetch(contextPath + '/api/user-info', {\n");
      out.write("                    credentials: 'same-origin'\n");
      out.write("                });\n");
      out.write("                const data = await response.json();\n");
      out.write("                // Debug - hiển thị thông tin user trả về\n");
      out.write("                console.log('User info response:', data);\n");
      out.write("                if (data && data.isLoggedIn && data.userId) {\n");
      out.write("                    return data.userId;\n");
      out.write("                }\n");
      out.write("                return null;\n");
      out.write("            } catch (error) {\n");
      out.write("                console.error('Error getting user info:', error);\n");
      out.write("                return null;\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Load Reviews for Product\n");
      out.write("        function loadProductReviews(productId) {\n");
      out.write("            console.log('Loading reviews for product ID:', productId);\n");
      out.write("            \n");
      out.write("            if (!productId) {\n");
      out.write("                console.error('Product ID is required to load reviews');\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Load review statistics\n");
      out.write("            fetch(contextPath + '/api/reviews/product/' + productId + '/statistics')\n");
      out.write("            .then(response => {\n");
      out.write("                console.log('Statistics API response status:', response.status);\n");
      out.write("                if (!response.ok) {\n");
      out.write("                    throw new Error('Statistics API returned status: ' + response.status);\n");
      out.write("                }\n");
      out.write("                return response.json();\n");
      out.write("            })\n");
      out.write("            .then(data => {\n");
      out.write("                console.log('Review statistics response:', data);\n");
      out.write("                if (data.success && data.statistics) {\n");
      out.write("                    updateReviewStatistics(data.statistics);\n");
      out.write("                } else {\n");
      out.write("                    console.warn('Statistics API succeeded but no valid data:', data);\n");
      out.write("                }\n");
      out.write("            })\n");
      out.write("            .catch(error => {\n");
      out.write("                console.error('Error loading review statistics:', error);\n");
      out.write("                // Don't fail the whole process for statistics\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            // Load reviews list\n");
      out.write("            const reviewsUrl = contextPath + '/api/reviews/product/' + productId;\n");
      out.write("            console.log('Fetching reviews from URL:', reviewsUrl);\n");
      out.write("            \n");
      out.write("            fetch(reviewsUrl, {\n");
      out.write("                method: 'GET',\n");
      out.write("                headers: {\n");
      out.write("                    'Accept': 'application/json',\n");
      out.write("                    'Cache-Control': 'no-cache'\n");
      out.write("                },\n");
      out.write("                credentials: 'same-origin'\n");
      out.write("            })\n");
      out.write("            .then(response => {\n");
      out.write("                console.log('Reviews API response status:', response.status);\n");
      out.write("                console.log('Reviews API response headers:', response.headers);\n");
      out.write("                \n");
      out.write("                if (!response.ok) {\n");
      out.write("                    throw new Error('Reviews API returned status: ' + response.status);\n");
      out.write("                }\n");
      out.write("                \n");
      out.write("                return response.text().then(text => {\n");
      out.write("                    console.log('Raw response text:', text);\n");
      out.write("                    try {\n");
      out.write("                        return JSON.parse(text);\n");
      out.write("                    } catch (parseError) {\n");
      out.write("                        console.error('JSON parse error:', parseError);\n");
      out.write("                        console.error('Response text that failed to parse:', text);\n");
      out.write("                        throw new Error('Invalid JSON response from reviews API');\n");
      out.write("                    }\n");
      out.write("                });\n");
      out.write("            })\n");
      out.write("            .then(data => {\n");
      out.write("                console.log('Reviews list response data:', data);\n");
      out.write("                console.log('Data type:', typeof data);\n");
      out.write("                console.log('Data keys:', Object.keys(data || {}));\n");
      out.write("                \n");
      out.write("                if (data && data.success) {\n");
      out.write("                    // Handle different possible response structures\n");
      out.write("                    let reviewsArray = [];\n");
      out.write("                    \n");
      out.write("                    if (data.reviews && Array.isArray(data.reviews)) {\n");
      out.write("                        reviewsArray = data.reviews;\n");
      out.write("                    } else if (data.data && Array.isArray(data.data)) {\n");
      out.write("                        reviewsArray = data.data;\n");
      out.write("                    } else if (Array.isArray(data)) {\n");
      out.write("                        reviewsArray = data;\n");
      out.write("                    }\n");
      out.write("                    \n");
      out.write("                    console.log('Extracted reviews array:', reviewsArray);\n");
      out.write("                    console.log('Number of reviews found:', reviewsArray.length);\n");
      out.write("                    \n");
      out.write("                    if (reviewsArray.length > 0) {\n");
      out.write("                        console.log('Sample review data:', reviewsArray[0]);\n");
      out.write("                    }\n");
      out.write("                    \n");
      out.write("                    displayReviews(reviewsArray);\n");
      out.write("                } else {\n");
      out.write("                    console.error('Failed to load reviews:', data ? data.message : 'Unknown error');\n");
      out.write("                    console.log('Full error response:', data);\n");
      out.write("                    displayReviews([]);\n");
      out.write("                }\n");
      out.write("            })\n");
      out.write("            .catch(error => {\n");
      out.write("                console.error('Error loading reviews:', error);\n");
      out.write("                console.error('Error details:', error.message);\n");
      out.write("                displayReviews([]);\n");
      out.write("                \n");
      out.write("                // Show user-friendly error in the UI\n");
      out.write("                const dynamicReviews = document.getElementById('dynamicReviews');\n");
      out.write("                if (dynamicReviews) {\n");
      out.write("                    dynamicReviews.innerHTML = '<div class=\"alert alert-warning text-center\">' +\n");
      out.write("                        '<i class=\"fas fa-exclamation-triangle me-2\"></i>' +\n");
      out.write("                        'Không thể tải đánh giá. Vui lòng thử lại sau.' +\n");
      out.write("                    '</div>';\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function updateReviewStatistics(stats) {\n");
      out.write("            // Update overall score\n");
      out.write("            const overallScore = document.getElementById('overallScore');\n");
      out.write("            if (overallScore) {\n");
      out.write("                overallScore.textContent = stats.averageRating || '0';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Update total reviews count\n");
      out.write("            const totalReviews = document.getElementById('totalReviews');\n");
      out.write("            if (totalReviews) {\n");
      out.write("                totalReviews.textContent = '(' + (stats.totalReviews || 0) + ' đánh giá)';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Update star display\n");
      out.write("            const overallStars = document.getElementById('overallStars');\n");
      out.write("            if (overallStars) {\n");
      out.write("                const rating = stats.averageRating || 0;\n");
      out.write("                const fullStars = Math.floor(rating);\n");
      out.write("                const hasHalfStar = (rating % 1) >= 0.5;\n");
      out.write("                \n");
      out.write("                let starsHtml = '';\n");
      out.write("                for (let i = 0; i < 5; i++) {\n");
      out.write("                    if (i < fullStars) {\n");
      out.write("                        starsHtml += '<i class=\"fas fa-star\"></i>';\n");
      out.write("                    } else if (i === fullStars && hasHalfStar) {\n");
      out.write("                        starsHtml += '<i class=\"fas fa-star-half-alt\"></i>';\n");
      out.write("                    } else {\n");
      out.write("                        starsHtml += '<i class=\"far fa-star\"></i>';\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("                overallStars.innerHTML = starsHtml;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Update rating breakdown bars\n");
      out.write("            if (stats.ratingBreakdown) {\n");
      out.write("                const ratingBars = document.querySelectorAll('.rating-bar');\n");
      out.write("                for (let i = 1; i <= 5; i++) {\n");
      out.write("                    const breakdownData = stats.ratingBreakdown[i + '_star'];\n");
      out.write("                    if (breakdownData && ratingBars[5-i]) {\n");
      out.write("                        const bar = ratingBars[5-i];\n");
      out.write("                        const fill = bar.querySelector('.bar-fill');\n");
      out.write("                        const count = bar.querySelector('.rating-count');\n");
      out.write("                        \n");
      out.write("                        if (fill) fill.style.width = breakdownData.percentage + '%';\n");
      out.write("                        if (count) count.textContent = breakdownData.count;\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function displayReviews(reviews) {\n");
      out.write("            console.log('Displaying reviews:', reviews);\n");
      out.write("            const dynamicReviews = document.getElementById('dynamicReviews');\n");
      out.write("            if (!dynamicReviews) {\n");
      out.write("                console.error('dynamicReviews element not found');\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Clear existing reviews\n");
      out.write("            dynamicReviews.innerHTML = '';\n");
      out.write("            \n");
      out.write("            if (!reviews || reviews.length === 0) {\n");
      out.write("                console.log('No reviews to display');\n");
      out.write("                const noReviewsHtml = '<div class=\"no-reviews text-center py-4\">' +\n");
      out.write("                    '<i class=\"fas fa-comment-slash fa-3x text-muted mb-3\"></i>' +\n");
      out.write("                    '<h5 class=\"text-muted\">Chưa có đánh giá nào</h5>' +\n");
      out.write("                    '<p class=\"text-muted\">Hãy là người đầu tiên đánh giá sản phẩm này!</p>' +\n");
      out.write("                '</div>';\n");
      out.write("                dynamicReviews.innerHTML = noReviewsHtml;\n");
      out.write("                return;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Display reviews\n");
      out.write("            console.log('Creating HTML for ' + reviews.length + ' reviews');\n");
      out.write("            let reviewsHtml = '';\n");
      out.write("            reviews.forEach((review, index) => {\n");
      out.write("                try {\n");
      out.write("                    reviewsHtml += createReviewHtml(review);\n");
      out.write("                } catch (e) {\n");
      out.write("                    console.error('Error creating HTML for review #' + index, e);\n");
      out.write("                    console.error('Problem review:', review);\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("            \n");
      out.write("            dynamicReviews.innerHTML = reviewsHtml;\n");
      out.write("            \n");
      out.write("            // Re-attach review filter event listener\n");
      out.write("            const reviewFilter = document.getElementById('reviewFilter');\n");
      out.write("            if (reviewFilter) {\n");
      out.write("                // Remove existing listeners\n");
      out.write("                reviewFilter.removeEventListener('change', handleReviewFilter);\n");
      out.write("                reviewFilter.addEventListener('change', handleReviewFilter);\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function handleReviewFilter(e) {\n");
      out.write("            const filterValue = e.target.value;\n");
      out.write("            const reviewItems = document.querySelectorAll('.review-item');\n");
      out.write("            \n");
      out.write("            reviewItems.forEach(item => {\n");
      out.write("                if (filterValue === 'all') {\n");
      out.write("                    item.style.display = 'block';\n");
      out.write("                } else {\n");
      out.write("                    const stars = item.querySelectorAll('.review-rating .fas.fa-star');\n");
      out.write("                    const reviewRating = stars.length;\n");
      out.write("                    \n");
      out.write("                    if (reviewRating == filterValue) {\n");
      out.write("                        item.style.display = 'block';\n");
      out.write("                    } else {\n");
      out.write("                        item.style.display = 'none';\n");
      out.write("                    }\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function createReviewHtml(review) {\n");
      out.write("            console.log('Creating HTML for review:', review);\n");
      out.write("            \n");
      out.write("            // Check if review is valid\n");
      out.write("            if (!review || typeof review !== 'object') {\n");
      out.write("                console.error('Invalid review object:', review);\n");
      out.write("                return '';\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Ensure rating is valid (default to 1 if invalid)\n");
      out.write("            const rating = Math.max(1, Math.min(5, parseInt(review.rating) || 1));\n");
      out.write("            \n");
      out.write("            // Format stars based on rating\n");
      out.write("            const stars = generateStarsHtml(rating);\n");
      out.write("            \n");
      out.write("            // Use the timeAgo method from the Review object if available, otherwise format the date\n");
      out.write("            let timeDisplay = 'Vừa xong';\n");
      out.write("            if (review.timeAgo && review.timeAgo.trim() !== '') {\n");
      out.write("                timeDisplay = review.timeAgo;\n");
      out.write("            } else if (review.createdAt) {\n");
      out.write("                timeDisplay = formatDate(review.createdAt);\n");
      out.write("            } else if (review.created_at) {\n");
      out.write("                timeDisplay = formatDate(review.created_at);\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Verified badge display\n");
      out.write("            const isVerified = review.isVerified === true || review.isVerified === 'true' || review.is_verified === true || review.is_verified === 'true';\n");
      out.write("            const verifiedBadge = isVerified ? \n");
      out.write("                '<span class=\"verified-badge ms-2\"><i class=\"fas fa-check-circle\"></i> Đã mua hàng</span>' : '';\n");
      out.write("                \n");
      out.write("            // Display username or user ID\n");
      out.write("            let reviewerName = 'Khách hàng';\n");
      out.write("            if (review.userName && review.userName.trim() !== '') {\n");
      out.write("                reviewerName = review.userName;\n");
      out.write("            } else if (review.user_name && review.user_name.trim() !== '') {\n");
      out.write("                reviewerName = review.user_name;\n");
      out.write("            } else if (review.userEmail && review.userEmail.trim() !== '') {\n");
      out.write("                reviewerName = review.userEmail.split('@')[0]; // Use email prefix\n");
      out.write("            } else if (review.user_email && review.user_email.trim() !== '') {\n");
      out.write("                reviewerName = review.user_email.split('@')[0]; // Use email prefix\n");
      out.write("            } else {\n");
      out.write("                const userId = review.userId || review.user_id || 'unknown';\n");
      out.write("                reviewerName = `Người dùng #");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${userId}", java.lang.String.class, (jakarta.servlet.jsp.PageContext)_jspx_page_context, null));
      out.write("`;\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Ensure comment is valid\n");
      out.write("            const comment = (review.comment && review.comment.trim() !== '') ? review.comment.trim() : 'Người dùng chưa để lại bình luận.';\n");
      out.write("            \n");
      out.write("            // Debug log for this specific review\n");
      out.write("            console.log('Processing review:', {\n");
      out.write("                id: review.id,\n");
      out.write("                userId: review.userId,\n");
      out.write("                rating: rating,\n");
      out.write("                comment: review.comment,\n");
      out.write("                createdAt: review.createdAt,\n");
      out.write("                timeAgo: review.timeAgo,\n");
      out.write("                isVerified: review.isVerified\n");
      out.write("            });\n");
      out.write("\n");
      out.write("            return '<div class=\"review-item\">' +\n");
      out.write("                '<div class=\"review-header\">' +\n");
      out.write("                    '<div class=\"reviewer-info\">' +\n");
      out.write("                        '<div class=\"reviewer-avatar\">' +\n");
      out.write("                            '<i class=\"fas fa-user-circle\"></i>' +\n");
      out.write("                        '</div>' +\n");
      out.write("                        '<div class=\"reviewer-details\">' +\n");
      out.write("                            '<h5 class=\"reviewer-name\">' + escapeHtml(reviewerName) + verifiedBadge + '</h5>' +\n");
      out.write("                            '<div class=\"review-rating\">' + stars + '</div>' +\n");
      out.write("                            '<span class=\"review-date\">' + timeDisplay + '</span>' +\n");
      out.write("                        '</div>' +\n");
      out.write("                    '</div>' +\n");
      out.write("                '</div>' +\n");
      out.write("                '<div class=\"review-content\">' +\n");
      out.write("                    (review.title ? '<h6 class=\"review-title\">' + escapeHtml(review.title) + '</h6>' : '') +\n");
      out.write("                    '<p class=\"review-text\">' + escapeHtml(comment) + '</p>' +\n");
      out.write("                    '<div class=\"review-actions\">' +\n");
      out.write("                        '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" onclick=\"markHelpful(' + (review.id || 0) + ')\">' +\n");
      out.write("                            '<i class=\"fas fa-thumbs-up me-1\"></i>Hữu ích (' + (review.helpfulCount || 0) + ')' +\n");
      out.write("                        '</button>' +\n");
      out.write("                    '</div>' +\n");
      out.write("                '</div>' +\n");
      out.write("            '</div>';\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function generateStarsHtml(rating) {\n");
      out.write("            let starsHtml = '';\n");
      out.write("            const safeRating = Math.max(1, Math.min(5, parseInt(rating) || 1));\n");
      out.write("            \n");
      out.write("            for (let i = 1; i <= 5; i++) {\n");
      out.write("                if (i <= safeRating) {\n");
      out.write("                    starsHtml += '<i class=\"fas fa-star\"></i>';\n");
      out.write("                } else {\n");
      out.write("                    starsHtml += '<i class=\"far fa-star\"></i>';\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("            return starsHtml;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Hàm trực tiếp để lấy user id từ session\n");
      out.write("        function getUserIdFromSession() {\n");
      out.write("            const sessionValue = '");
      out.print( session.getAttribute("userId") );
      out.write("';\n");
      out.write("            console.log('Raw session userId value:', sessionValue);\n");
      out.write("            \n");
      out.write("            if (sessionValue && sessionValue !== 'null' && sessionValue.trim() !== '') {\n");
      out.write("                const parsedId = parseInt(sessionValue);\n");
      out.write("                console.log('Parsed userId:', parsedId);\n");
      out.write("                if (!isNaN(parsedId) && parsedId > 0) {\n");
      out.write("                    return parsedId;\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            console.log('No valid userId found in session');\n");
      out.write("            return null;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function escapeHtml(text) {\n");
      out.write("            if (!text) return '';\n");
      out.write("            const div = document.createElement('div');\n");
      out.write("            div.textContent = text;\n");
      out.write("            return div.innerHTML;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function formatDate(dateString) {\n");
      out.write("            if (!dateString) return '';\n");
      out.write("            try {\n");
      out.write("                const date = new Date(dateString);\n");
      out.write("                const now = new Date();\n");
      out.write("                const diffMs = now - date;\n");
      out.write("                const diffMinutes = Math.floor(diffMs / (1000 * 60));\n");
      out.write("                \n");
      out.write("                if (diffMinutes < 60) {\n");
      out.write("                    return diffMinutes + ' phút trước';\n");
      out.write("                } else if (diffMinutes < 1440) {\n");
      out.write("                    return Math.floor(diffMinutes / 60) + ' giờ trước';\n");
      out.write("                } else if (diffMinutes < 10080) {\n");
      out.write("                    return Math.floor(diffMinutes / 1440) + ' ngày trước';\n");
      out.write("                } else {\n");
      out.write("                    return date.toLocaleDateString('vi-VN');\n");
      out.write("                }\n");
      out.write("            } catch (e) {\n");
      out.write("                return 'Vừa xong';\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function markHelpful(reviewId) {\n");
      out.write("            alert('Cảm ơn phản hồi của bạn!');\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        // Review Filter\n");
      out.write("        const reviewFilter = document.getElementById('reviewFilter');\n");
      out.write("        if (reviewFilter) {\n");
      out.write("            reviewFilter.addEventListener('change', (e) => {\n");
      out.write("                const filterValue = e.target.value;\n");
      out.write("                const reviewItems = document.querySelectorAll('.review-item');\n");
      out.write("                \n");
      out.write("                reviewItems.forEach(item => {\n");
      out.write("                    if (filterValue === 'all') {\n");
      out.write("                        item.style.display = 'block';\n");
      out.write("                    } else {\n");
      out.write("                        const stars = item.querySelectorAll('.review-rating .fas.fa-star');\n");
      out.write("                        const reviewRating = stars.length;\n");
      out.write("                        \n");
      out.write("                        if (reviewRating == filterValue) {\n");
      out.write("                            item.style.display = 'block';\n");
      out.write("                        } else {\n");
      out.write("                            item.style.display = 'none';\n");
      out.write("                        }\n");
      out.write("                    }\n");
      out.write("                });\n");
      out.write("            });\n");
      out.write("        }\n");
      out.write("\n");
      out.write("        // ===== AUTHENTICATION & USER INFO =====\n");
      out.write("        \n");
      out.write("        function initializeUserAuth() {\n");
      out.write("            // Check multiple sources for user info\n");
      out.write("            const userInfo = getUserInfo();\n");
      out.write("            \n");
      out.write("            if (userInfo && userInfo.name) {\n");
      out.write("                displayUserInfo(userInfo);\n");
      out.write("            } else {\n");
      out.write("                displayLoginButton();\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function getUserInfo() {\n");
      out.write("            // Check localStorage first\n");
      out.write("            let userInfo = localStorage.getItem('userInfo');\n");
      out.write("            if (userInfo) {\n");
      out.write("                try {\n");
      out.write("                    return JSON.parse(userInfo);\n");
      out.write("                } catch (e) {\n");
      out.write("                    console.error('Error parsing userInfo from localStorage:', e);\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Check sessionStorage\n");
      out.write("            userInfo = sessionStorage.getItem('userInfo');\n");
      out.write("            if (userInfo) {\n");
      out.write("                try {\n");
      out.write("                    return JSON.parse(userInfo);\n");
      out.write("                } catch (e) {\n");
      out.write("                    console.error('Error parsing userInfo from sessionStorage:', e);\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            // Check for OAuth success in URL params (for redirect scenarios)\n");
      out.write("            const urlParams = new URLSearchParams(window.location.search);\n");
      out.write("            if (urlParams.get('login') === 'success') {\n");
      out.write("                // Try to get user info via API call if needed\n");
      out.write("                return null; // Will trigger login button display\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            return null;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function displayUserInfo(userInfo) {\n");
      out.write("            const userName = userInfo.name || userInfo.email || userInfo.username || 'Người dùng';\n");
      out.write("            \n");
      out.write("            const navUserInfo = document.getElementById('nav-user-info');\n");
      out.write("            const navLoginBtn = document.getElementById('nav-login-btn');\n");
      out.write("            \n");
      out.write("            if (navUserInfo && navLoginBtn) {\n");
      out.write("                navUserInfo.innerHTML = \n");
      out.write("                    '<div class=\"dropdown\">' +\n");
      out.write("                        '<a href=\"#\" class=\"btn btn-outline-primary dropdown-toggle\" ' +\n");
      out.write("                           'id=\"userDropdown\" role=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">' +\n");
      out.write("                            '<i class=\"fas fa-user-circle me-1\"></i>' +\n");
      out.write("                            '<span class=\"d-none d-md-inline\">' + userName + '</span>' +\n");
      out.write("                        '</a>' +\n");
      out.write("                        '<ul class=\"dropdown-menu dropdown-menu-end\" aria-labelledby=\"userDropdown\">' +\n");
      out.write("                            '<li><h6 class=\"dropdown-header\">' +\n");
      out.write("                                '<i class=\"fas fa-user-circle me-2\"></i>' + userName +\n");
      out.write("                            '</h6></li>' +\n");
      out.write("                            '<li><hr class=\"dropdown-divider\"></li>' +\n");
      out.write("                            '<li><a class=\"dropdown-item\" href=\"' + contextPath + '/profile.jsp\">' +\n");
      out.write("                                '<i class=\"fas fa-user me-2\"></i>Hồ sơ cá nhân' +\n");
      out.write("                            '</a></li>' +\n");
      out.write("                            '<li><a class=\"dropdown-item\" href=\"' + contextPath + '/orders\">' +\n");
      out.write("                                '<i class=\"fas fa-box me-2\"></i>Đơn hàng của tôi' +\n");
      out.write("                            '</a></li>' +\n");
      out.write("                            '<li><a class=\"dropdown-item\" href=\"' + contextPath + '/wishlist\">' +\n");
      out.write("                                '<i class=\"fas fa-heart me-2\"></i>Danh sách yêu thích' +\n");
      out.write("                            '</a></li>' +\n");
      out.write("                            '<li><a class=\"dropdown-item\" href=\"' + contextPath + '/settings\">' +\n");
      out.write("                                '<i class=\"fas fa-cog me-2\"></i>Cài đặt' +\n");
      out.write("                            '</a></li>' +\n");
      out.write("                            '<li><hr class=\"dropdown-divider\"></li>' +\n");
      out.write("                            '<li><a class=\"dropdown-item text-danger\" href=\"#\" onclick=\"logoutUser()\">' +\n");
      out.write("                                '<i class=\"fas fa-sign-out-alt me-2\"></i>Đăng xuất' +\n");
      out.write("                            '</a></li>' +\n");
      out.write("                        '</ul>' +\n");
      out.write("                    '</div>';\n");
      out.write("                \n");
      out.write("                navUserInfo.classList.remove('d-none');\n");
      out.write("                navLoginBtn.classList.add('d-none');\n");
      out.write("                \n");
      out.write("                // Initialize Bootstrap dropdown\n");
      out.write("                const dropdownTrigger = navUserInfo.querySelector('[data-bs-toggle=\"dropdown\"]');\n");
      out.write("                if (dropdownTrigger && window.bootstrap) {\n");
      out.write("                    new bootstrap.Dropdown(dropdownTrigger);\n");
      out.write("                }\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function displayLoginButton() {\n");
      out.write("            const navUserInfo = document.getElementById('nav-user-info');\n");
      out.write("            const navLoginBtn = document.getElementById('nav-login-btn');\n");
      out.write("            \n");
      out.write("            if (navUserInfo && navLoginBtn) {\n");
      out.write("                navUserInfo.classList.add('d-none');\n");
      out.write("                navLoginBtn.classList.remove('d-none');\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        function logoutUser() {\n");
      out.write("            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {\n");
      out.write("                // Clear all stored user data\n");
      out.write("                localStorage.removeItem('userInfo');\n");
      out.write("                sessionStorage.removeItem('userInfo');\n");
      out.write("                localStorage.removeItem('authToken');\n");
      out.write("                sessionStorage.removeItem('authToken');\n");
      out.write("                \n");
      out.write("                // Clear any other auth-related storage\n");
      out.write("                Object.keys(localStorage).forEach(key => {\n");
      out.write("                    if (key.startsWith('auth_') || key.startsWith('user_')) {\n");
      out.write("                        localStorage.removeItem(key);\n");
      out.write("                    }\n");
      out.write("                });\n");
      out.write("                \n");
      out.write("                // Redirect to home page\n");
      out.write("                window.location.href = contextPath + '/';\n");
      out.write("            }\n");
      out.write("        }\n");
      out.write("\n");
      out.write("        // Initialize authentication when DOM is loaded\n");
      out.write("        document.addEventListener('DOMContentLoaded', function() {\n");
      out.write("            initializeUserAuth();\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("        // Re-check auth status when user returns to tab (in case of logout in another tab)\n");
      out.write("        document.addEventListener('visibilitychange', function() {\n");
      out.write("            if (!document.hidden) {\n");
      out.write("                initializeUserAuth();\n");
      out.write("            }\n");
      out.write("        });\n");
      out.write("    </script>\n");
      out.write("    \n");
      out.write("    <!-- Search Autocomplete Script -->\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/search-autocomplete.js\"></script>\n");
      out.write("</body>\n");
      out.write("</html>");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof jakarta.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
